---
phase: 04-mail-read-operations
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/zoho/mail_types.go
  - internal/zoho/mail_client.go
  - internal/cli/mail_folders.go
  - internal/cli/mail_messages.go
  - internal/cli/cli.go
autonomous: true

must_haves:
  truths:
    - "User can run `zoh mail folders list` and see all mail folders"
    - "User can run `zoh mail labels list` and see all labels/tags"
    - "User can run `zoh mail messages list` and see paginated messages in a folder"
    - "User can run `zoh mail messages get` and see full message headers and body"
    - "Mail client automatically resolves account ID without user input"
  artifacts:
    - path: "internal/zoho/mail_types.go"
      provides: "Mail API type definitions (accounts, folders, labels, messages, attachments)"
      contains: "type MessageSummary struct"
    - path: "internal/zoho/mail_client.go"
      provides: "MailClient with cached accountId, folder/label/message methods"
      contains: "type MailClient struct"
    - path: "internal/cli/mail_folders.go"
      provides: "CLI commands for folder and label listing"
      contains: "type MailFoldersListCmd struct"
    - path: "internal/cli/mail_messages.go"
      provides: "CLI commands for message list and get"
      contains: "type MailMessagesListCmd struct"
    - path: "internal/cli/cli.go"
      provides: "Mail command tree registration"
      contains: "Mail.*MailCmd"
  key_links:
    - from: "internal/cli/mail_messages.go"
      to: "internal/zoho/mail_client.go"
      via: "MailClient.ListMessages, GetMessageMetadata, GetMessageContent"
      pattern: "mc\\.ListMessages|mc\\.GetMessage"
    - from: "internal/cli/mail_folders.go"
      to: "internal/zoho/mail_client.go"
      via: "MailClient.ListFolders, ListLabels"
      pattern: "mc\\.ListFolders|mc\\.ListLabels"
    - from: "internal/zoho/mail_client.go"
      to: "internal/zoho/client.go"
      via: "Client.DoMail for mail API base URL"
      pattern: "client\\.DoMail"
---

<objective>
Build the mail API client layer with account ID resolution, mail type definitions, folder/label listing, and message list/get CLI commands.

Purpose: Establishes the reusable mail infrastructure (MailClient, mail types) that all Phase 4 commands depend on, and delivers folder/label listing (MAIL-READ-04, MAIL-READ-05) plus message list/get (MAIL-READ-01, MAIL-READ-02).
Output: Working `zoh mail folders list`, `zoh mail labels list`, `zoh mail messages list`, and `zoh mail messages get` commands.
</objective>

<execution_context>
@/home/semmy/.claude/get-shit-done/workflows/execute-plan.md
@/home/semmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-mail-read-operations/04-RESEARCH.md
@internal/zoho/client.go
@internal/zoho/admin_client.go
@internal/zoho/pagination.go
@internal/zoho/types.go
@internal/cli/cli.go
@internal/cli/admin_users.go
@internal/output/formatter.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mail API types, MailClient with account ID resolution, and folder/label/message methods</name>
  <files>internal/zoho/mail_types.go, internal/zoho/mail_client.go</files>
  <action>
Create two new files in internal/zoho/:

**mail_types.go** — Mail API request/response structs with JSON tags (SEPARATE file from types.go to keep admin vs mail types isolated):
- `MailAccount` struct: AccountID string `json:"accountId"`, EmailAddress string `json:"emailAddress"`, AccountDisplayName string `json:"accountDisplayName"`, Type string `json:"type"`, Status string `json:"status"`
- `MailAccountListResponse` with nested Status (Code int, Description string) and Data []MailAccount
- `Folder` struct: FolderID string `json:"folderId"`, FolderName string `json:"folderName"`, FolderType string `json:"folderType"`, Path string `json:"path"`, UnreadCount int `json:"unreadCount"`, MessageCount int `json:"messageCount"`
- `FolderListResponse` with Status and Data []Folder
- `Label` struct: LabelID string `json:"labelId"`, LabelName string `json:"labelName"`, LabelColor string `json:"labelColor"`
- `LabelListResponse` with Status and Data []Label
- `MessageSummary` struct: MessageID string `json:"messageId"`, ThreadID string `json:"threadId"`, Subject string `json:"subject"`, FromAddress string `json:"fromAddress"`, Sender string `json:"sender"`, ReceivedTime int64 `json:"receivedTime"` (unix ms), Status string `json:"status"` (READ/UNREAD), HasAttachment bool `json:"hasAttachment"`, FlagID int `json:"flagid"`, Priority int `json:"priority"`, Summary string `json:"summary"`
- `MessageListResponse` with Status and Data []MessageSummary
- `MessageMetadata` struct: MessageID string, ThreadID string, FolderID string, Subject string, FromAddress string, Sender string, ToAddress string `json:"toAddress"`, CcAddress string `json:"ccAddress"`, SentDateInGMT int64 `json:"sentDateInGMT"` (unix ms), ReceivedTime int64, MessageSize int64, HasAttachment bool, HasInline bool, Status string, Priority int, FlagID int
- `MessageMetadataResponse` with Status and Data MessageMetadata
- `MessageContent` struct: MessageID string `json:"messageId"`, Content string `json:"content"` (HTML body)
- `MessageContentResponse` with Status and Data MessageContent
- `Attachment` struct: AttachmentID string `json:"attachmentId"`, AttachmentName string `json:"attachmentName"`, AttachmentSize int64 `json:"attachmentSize"`, AttachmentType string `json:"attachmentType"` (MIME type)
- `AttachmentListResponse` with Status and Data []Attachment

Note on ToAddress/CcAddress: The Zoho Mail API returns these as comma-separated strings in some endpoints, not arrays. Use `string` type (not `[]string`) to match actual API response format. The CLI display layer will handle formatting.

**mail_client.go** — MailClient wrapping zoho.Client (mirrors AdminClient pattern):
- `MailClient` struct with `client *Client` and `accountID string` fields
- `NewMailClient(cfg *config.Config, tokenSource oauth2.TokenSource) (*MailClient, error)` — creates Client via NewClient, calls getPrimaryAccountID to cache accountID
- `getPrimaryAccountID(ctx context.Context) (string, error)` — GET /api/accounts via client.DoMail, decode MailAccountListResponse, return first account's AccountID. Error if no accounts found.
- `parseErrorResponse(resp *http.Response) error` — same pattern as AdminClient: read body, try decode APIError, return formatted error
- `ListFolders(ctx context.Context) ([]Folder, error)` — GET /api/accounts/{accountId}/folders via client.DoMail
- `GetFolderByName(ctx context.Context, name string) (*Folder, error)` — calls ListFolders, iterates to find by FolderName (case-insensitive comparison using strings.EqualFold)
- `ListLabels(ctx context.Context) ([]Label, error)` — GET /api/accounts/{accountId}/labels via client.DoMail
- `ListMessages(ctx context.Context, folderID string, start, limit int) ([]MessageSummary, error)` — GET /api/accounts/{accountId}/messages/view?folderId={folderID}&start={start}&limit={limit} via client.DoMail
- `GetMessageMetadata(ctx context.Context, folderID, messageID string) (*MessageMetadata, error)` — GET /api/accounts/{accountId}/folders/{folderId}/messages/{messageId}/details via client.DoMail (note: this is the details endpoint, not /metadata)
- `GetMessageContent(ctx context.Context, folderID, messageID string) (*MessageContent, error)` — GET /api/accounts/{accountId}/folders/{folderId}/messages/{messageId}/content via client.DoMail

CRITICAL: Use `client.DoMail` (not `client.Do`) for ALL mail endpoints. The DoMail method uses the MailBase URL (e.g., https://mail.zoho.eu) while Do uses APIBase (e.g., https://www.zohoapis.eu). This is the fundamental architectural difference from AdminClient.

Ensure both files compile: `go build ./internal/zoho/...`
  </action>
  <verify>
Run `go build ./internal/zoho/...` — must compile with no errors.
Run `go vet ./internal/zoho/...` — no warnings.
  </verify>
  <done>
MailClient compiles with cached accountID. Has methods: NewMailClient, ListFolders, GetFolderByName, ListLabels, ListMessages, GetMessageMetadata, GetMessageContent. All mail types defined in mail_types.go.
  </done>
</task>

<task type="auto">
  <name>Task 2: Folder/label list and message list/get CLI commands with mail command tree</name>
  <files>internal/cli/mail_folders.go, internal/cli/mail_messages.go, internal/cli/cli.go</files>
  <action>
Create two new CLI files and update cli.go:

**mail_folders.go** — newMailClient helper + folder and label commands:

`newMailClient` helper (mirrors newAdminClient pattern from admin_users.go):
```go
func newMailClient(cfg *config.Config) (*zoho.MailClient, error) {
    store, err := secrets.NewStore()
    // ... same pattern as newAdminClient: secrets.NewStore -> auth.NewTokenCache -> zoho.NewMailClient
    // Wrap errors in output.CLIError with appropriate exit codes
}
```

`MailFoldersListCmd` struct (no flags needed — API returns all folders in single response):
- Run method: creates MailClient, calls ListFolders, outputs via fp.Formatter.PrintList
- Columns: Name (FolderName), Type (FolderType), Path, Messages (MessageCount), Unread (UnreadCount), ID (FolderID)

`MailLabelsListCmd` struct (no flags needed):
- Run method: creates MailClient, calls ListLabels, outputs via fp.Formatter.PrintList
- Columns: Name (LabelName), Color (LabelColor), ID (LabelID)

**mail_messages.go** — Message list and get commands:

`MailMessagesListCmd` struct:
- Folder string `help:"Folder name or ID" default:"Inbox" short:"f"`
- Limit int `help:"Maximum messages to show" short:"l" default:"50"`
- All bool `help:"Fetch all messages (no pagination limit)" short:"a"`
- Run method: creates MailClient, resolves folder (try GetFolderByName first, if error treat as folder ID), calls ListMessages with pagination. Uses PageIterator for --all. Outputs via PrintList.
- Columns: Status (Status), From (FromAddress), Subject (Subject), Date (display ReceivedTime formatted — use a display struct `MessageListRow` with string Date field, convert unix ms to "2006-01-02 15:04" format), Attachment (HasAttachment — display "Y"/"" for compactness), ID (MessageID)
- Create `MessageListRow` display struct for formatting: Status, FromAddress, Subject, Date string, Attachment string, MessageID string. Map MessageSummary to MessageListRow before printing.

`MailMessagesGetCmd` struct:
- MessageID string `arg:"" help:"Message ID to retrieve"`
- Folder string `help:"Folder name or ID (required)" short:"f" required:""`
- Run method: creates MailClient, resolves folder, fetches metadata via GetMessageMetadata AND content via GetMessageContent (two API calls — three-tier pattern). Builds a `MessageDetail` display struct combining both, outputs via fp.Formatter.Print.
- `MessageDetail` display struct: Subject, From (FromAddress), To (ToAddress), Cc (CcAddress — omit if empty), Date (formatted SentDateInGMT), Size (human-readable MessageSize), Status, Priority (map int to string: 0="Normal", 1="High"), HasAttachment (bool->string), MessageID, ThreadID, FolderID, Body (Content — the HTML body as-is, or strip HTML tags for plain/rich modes using a simple regex to remove < > tags)

For HTML stripping in plain/rich modes: use a simple approach — `regexp.MustCompile("<[^>]*>").ReplaceAllString(content, "")` then `strings.TrimSpace`. This is adequate for terminal display. JSON mode returns raw HTML.

**cli.go** — Register mail command tree:
- Add `Mail MailCmd` to CLI struct with `cmd:"" help:"Mail operations"`
- `MailCmd` struct with Folders, Labels, Messages subcommands
- `MailFoldersCmd` with List subcommand
- `MailLabelsCmd` with List subcommand
- `MailMessagesCmd` with List, Get subcommands

This creates the hierarchy:
- `zoh mail folders list`
- `zoh mail labels list`
- `zoh mail messages list [--folder Inbox] [--limit 50] [--all]`
- `zoh mail messages get <id> --folder <name-or-id>`

Ensure `go build ./...` passes and help output is correct.
  </action>
  <verify>
Run `go build ./...` — full project compiles.
Run `go vet ./...` — no warnings.
Run `./zoh mail --help` — shows folders, labels, messages subcommands.
Run `./zoh mail folders list --help` — shows no required flags.
Run `./zoh mail labels list --help` — shows no required flags.
Run `./zoh mail messages list --help` — shows --folder, --limit, --all flags.
Run `./zoh mail messages get --help` — shows message-id argument and --folder flag.
  </verify>
  <done>
`zoh mail folders list`, `zoh mail labels list`, `zoh mail messages list`, and `zoh mail messages get` commands registered, compile, and show correct help. Commands create MailClient, call API methods, and format output via Formatter in all three output modes. Message list uses display structs for timestamp formatting. Message get combines metadata + content (three-tier retrieval).
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` — entire project compiles
2. `go vet ./...` — no warnings
3. `./zoh mail --help` — shows folders, labels, messages subcommands
4. `./zoh mail folders list --help` — shows command help
5. `./zoh mail labels list --help` — shows command help
6. `./zoh mail messages list --help` — shows --folder, --limit, --all flags
7. `./zoh mail messages get --help` — shows message-id arg and --folder flag
8. MailClient, mail types exist in internal/zoho/
9. newMailClient helper follows same pattern as newAdminClient
</verification>

<success_criteria>
- MailClient wraps Client with cached accountID and uses DoMail for all requests
- MailClient has methods: ListFolders, GetFolderByName, ListLabels, ListMessages, GetMessageMetadata, GetMessageContent
- All mail types (Folder, Label, MessageSummary, MessageMetadata, MessageContent, Attachment) defined with proper JSON tags
- `zoh mail folders list` shows all folders with Name, Type, Path, Messages, Unread columns
- `zoh mail labels list` shows all labels with Name, Color columns
- `zoh mail messages list` shows paginated messages with Status, From, Subject, Date, Attachment columns
- `zoh mail messages get` shows full message with headers and body content
- Display structs handle timestamp formatting (unix ms to human-readable)
- HTML stripping for plain/rich modes in message body display
- Error responses parsed into readable CLIError messages
- All output modes (JSON, plain, rich) work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/04-mail-read-operations/04-01-SUMMARY.md`
</output>
