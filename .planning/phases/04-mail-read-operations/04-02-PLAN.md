---
phase: 04-mail-read-operations
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - internal/zoho/search.go
  - internal/zoho/mail_client.go
  - internal/cli/mail_messages.go
  - internal/cli/cli.go
autonomous: true

must_haves:
  truths:
    - "User can run `zoh mail messages search` with query flags and see matching messages"
    - "User can run `zoh mail messages thread` and see all messages in a conversation"
    - "User can run `zoh mail attachments list` and see attachments for a message"
    - "User can run `zoh mail attachments download` and save an attachment to local disk"
  artifacts:
    - path: "internal/zoho/search.go"
      provides: "SearchQuery builder for Zoho search syntax"
      contains: "type SearchQuery struct"
    - path: "internal/zoho/mail_client.go"
      provides: "SearchMessages, GetThread, ListAttachments, DownloadAttachment methods"
      contains: "func.*MailClient.*SearchMessages"
    - path: "internal/cli/mail_messages.go"
      provides: "Search and thread CLI commands"
      contains: "type MailMessagesSearchCmd struct"
    - path: "internal/cli/cli.go"
      provides: "Attachments command tree and search/thread in messages"
      contains: "Attachments.*MailAttachmentsCmd"
  key_links:
    - from: "internal/cli/mail_messages.go"
      to: "internal/zoho/search.go"
      via: "SearchQuery builder constructs search string for API"
      pattern: "zoho\\.NewSearchQuery|sq\\.Build"
    - from: "internal/cli/mail_messages.go"
      to: "internal/zoho/mail_client.go"
      via: "MailClient.SearchMessages, GetThread"
      pattern: "mc\\.SearchMessages|mc\\.GetThread"
    - from: "internal/cli/mail_messages.go"
      to: "internal/zoho/mail_client.go"
      via: "MailClient.ListAttachments, DownloadAttachment"
      pattern: "mc\\.ListAttachments|mc\\.DownloadAttachment"
---

<objective>
Add message search with query builder, thread viewing, and attachment listing/download to the mail CLI.

Purpose: Completes the remaining Phase 4 requirements: search (MAIL-READ-03), thread view (MAIL-READ-06), and attachment download (MAIL-READ-07).
Output: Working `zoh mail messages search`, `zoh mail messages thread`, `zoh mail attachments list`, and `zoh mail attachments download` commands.
</objective>

<execution_context>
@/home/semmy/.claude/get-shit-done/workflows/execute-plan.md
@/home/semmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-mail-read-operations/04-RESEARCH.md
@.planning/phases/04-mail-read-operations/04-01-SUMMARY.md
@internal/zoho/mail_client.go
@internal/zoho/mail_types.go
@internal/zoho/search.go
@internal/cli/mail_messages.go
@internal/cli/cli.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Search query builder and MailClient search/thread/attachment methods</name>
  <files>internal/zoho/search.go, internal/zoho/mail_client.go</files>
  <action>
Create search.go and add methods to mail_client.go:

**search.go** — SearchQuery builder for Zoho's proprietary search syntax:
- `SearchQuery` struct with `parts []string`
- `NewSearchQuery() *SearchQuery` — creates empty builder
- Chainable methods that return `*SearchQuery`:
  - `From(email string)` — appends `from:{email}`
  - `To(email string)` — appends `to:{email}`
  - `Subject(text string)` — appends `subject:{text}`
  - `DateAfter(date time.Time)` — appends `after:{date.Format("2006/01/02")}`
  - `DateBefore(date time.Time)` — appends `before:{date.Format("2006/01/02")}`
  - `HasAttachment()` — appends `has:attachment`
  - `IsUnread()` — appends `is:unread`
  - `Text(query string)` — appends raw text for general search
- `Build() string` — returns space-joined parts
- `IsEmpty() bool` — returns true if no parts added

**mail_client.go** — Add these methods to MailClient:

`SearchMessages(ctx context.Context, searchKey string, start, limit int) ([]MessageSummary, error)`:
- GET /api/accounts/{accountId}/messages/search?searchKey={url.QueryEscape(searchKey)}&start={start}&limit={limit}
- Uses client.DoMail
- Decodes MessageListResponse

`GetThread(ctx context.Context, folderID, threadID string, limit int) ([]MessageSummary, error)`:
- No dedicated thread GET endpoint in Zoho API — must filter client-side
- Fetch messages from folder using ListMessages with pagination
- Filter by matching ThreadID field
- Use limit parameter to cap total messages fetched (default 200 if 0). This prevents unbounded fetching in large folders.
- Approach: paginate through messages (200 per page max), collect matches, stop after scanning `limit` messages or exhausting folder
- Return filtered slice, error if no matches found

`ListAttachments(ctx context.Context, folderID, messageID string) ([]Attachment, error)`:
- GET /api/accounts/{accountId}/folders/{folderId}/messages/{messageId}/attachments
- Uses client.DoMail
- Decodes AttachmentListResponse

`DownloadAttachment(ctx context.Context, folderID, messageID, attachmentID, destPath string) error`:
- GET /api/accounts/{accountId}/folders/{folderId}/messages/{messageId}/attachments/{attachmentId}
- Uses client.DoMail
- Response is binary (application/octet-stream), NOT JSON
- Create destination file with os.Create
- Stream body to file with io.Copy (no memory buffering)
- Close file, return error on any failure
- If file creation fails, return error without attempting download
- On download error, attempt to remove partially written file with os.Remove (best-effort cleanup)

Ensure compilation: `go build ./internal/zoho/...`
  </action>
  <verify>
Run `go build ./internal/zoho/...` — must compile with no errors.
Run `go vet ./internal/zoho/...` — no warnings.
  </verify>
  <done>
SearchQuery builder compiles with all chainable methods. MailClient has SearchMessages, GetThread (client-side filtering), ListAttachments, and DownloadAttachment (binary streaming) methods.
  </done>
</task>

<task type="auto">
  <name>Task 2: Search, thread, and attachment CLI commands</name>
  <files>internal/cli/mail_messages.go, internal/cli/cli.go</files>
  <action>
Add commands to mail_messages.go and update cli.go:

**mail_messages.go** — Add search, thread, and attachment commands:

`MailMessagesSearchCmd` struct:
- Query string `arg:"" optional:"" help:"Free-text search query"`
- From string `help:"Filter by sender email" short:"f"`
- Subject string `help:"Filter by subject" short:"s"`
- After string `help:"Messages after date (YYYY-MM-DD)" short:"a"`
- Before string `help:"Messages before date (YYYY-MM-DD)" short:"b"`
- Unread bool `help:"Only unread messages" short:"u"`
- HasAttachment bool `help:"Only messages with attachments"`
- Limit int `help:"Maximum results" short:"l" default:"50"`
- Run method:
  1. Build SearchQuery from flags: if From set, call sq.From(); if Subject set, call sq.Subject(); parse After/Before dates with time.Parse("2006-01-02", ...) and call sq.DateAfter/DateBefore; if Unread, call sq.IsUnread(); if HasAttachment, call sq.HasAttachment(); if Query set, call sq.Text()
  2. If query is empty (no flags and no arg), return error "specify at least one search criterion"
  3. Call mc.SearchMessages(ctx, sq.Build(), 1, cmd.Limit)
  4. Map results to MessageListRow display structs (same as MailMessagesListCmd)
  5. Output via PrintList with same columns as message list

`MailMessagesThreadCmd` struct:
- ThreadID string `arg:"" help:"Thread ID to view"`
- Folder string `help:"Folder name or ID" default:"Inbox" short:"f"`
- Limit int `help:"Maximum messages to scan" short:"l" default:"200"`
- Run method:
  1. Creates MailClient, resolves folder (same pattern as MailMessagesListCmd)
  2. Calls mc.GetThread(ctx, folderID, cmd.ThreadID, cmd.Limit)
  3. Maps results to MessageListRow display structs
  4. Outputs via PrintList (shows all messages in thread chronologically)

`MailAttachmentsListCmd` struct:
- MessageID string `arg:"" help:"Message ID"`
- Folder string `help:"Folder name or ID (required)" short:"f" required:""`
- Run method:
  1. Creates MailClient, resolves folder
  2. Calls mc.ListAttachments(ctx, folderID, cmd.MessageID)
  3. Outputs via PrintList
  4. Columns: Name (AttachmentName), Size (AttachmentSize — format as human-readable bytes using a helper: KB/MB/GB), Type (AttachmentType), ID (AttachmentID)

Create a `formatBytes(bytes int64) string` helper in mail_messages.go:
- < 1024: "{n} B"
- < 1024*1024: "{n/1024:.1f} KB"
- < 1024*1024*1024: "{n/1024/1024:.1f} MB"
- else: "{n/1024/1024/1024:.1f} GB"

Create `AttachmentListRow` display struct: Name, Size, Type, AttachmentID string. Map Attachment to AttachmentListRow (format size with formatBytes).

`MailAttachmentsDownloadCmd` struct:
- AttachmentID string `arg:"" help:"Attachment ID to download"`
- MessageID string `help:"Message ID (required)" required:""`
- Folder string `help:"Folder name or ID (required)" short:"f" required:""`
- Output string `help:"Output file path (default: attachment name)" short:"o"`
- Run method:
  1. Creates MailClient, resolves folder
  2. If Output not specified: first call ListAttachments to get the attachment name, use it as Output (save to current directory). If attachment not found in list, error.
  3. Call mc.DownloadAttachment(ctx, folderID, cmd.MessageID, cmd.AttachmentID, destPath)
  4. Print confirmation to stderr: "Downloaded: {filename} ({size})"
  5. No stdout output (file is the output)

**cli.go** — Update command tree:
- Add `Search MailMessagesSearchCmd` and `Thread MailMessagesThreadCmd` to `MailMessagesCmd`
- Add `Attachments MailAttachmentsCmd` to `MailCmd`
- `MailAttachmentsCmd` struct with `List MailAttachmentsListCmd` and `Download MailAttachmentsDownloadCmd`

Updated hierarchy:
- `zoh mail messages search [query] [--from X] [--subject X] [--after X] [--before X] [--unread] [--has-attachment]`
- `zoh mail messages thread <thread-id> [--folder Inbox]`
- `zoh mail attachments list <message-id> --folder <name-or-id>`
- `zoh mail attachments download <attachment-id> --message-id <id> --folder <name-or-id> [--output path]`

Ensure `go build ./...` passes and help output is correct.
  </action>
  <verify>
Run `go build ./...` — full project compiles.
Run `go vet ./...` — no warnings.
Run `./zoh mail messages search --help` — shows query arg, --from, --subject, --after, --before, --unread, --has-attachment flags.
Run `./zoh mail messages thread --help` — shows thread-id arg and --folder flag.
Run `./zoh mail attachments list --help` — shows message-id arg and --folder flag.
Run `./zoh mail attachments download --help` — shows attachment-id arg, --message-id, --folder, --output flags.
  </verify>
  <done>
`zoh mail messages search`, `zoh mail messages thread`, `zoh mail attachments list`, and `zoh mail attachments download` commands registered, compile, and show correct help. Search builds query from flags using SearchQuery builder. Thread view uses client-side filtering by threadId. Attachment download streams binary to disk via io.Copy.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` — entire project compiles
2. `go vet ./...` — no warnings
3. `./zoh mail messages search --help` — shows all search flags
4. `./zoh mail messages thread --help` — shows thread-id arg
5. `./zoh mail attachments list --help` — shows message-id arg
6. `./zoh mail attachments download --help` — shows all required flags
7. SearchQuery builder exists in internal/zoho/search.go
8. MailClient has SearchMessages, GetThread, ListAttachments, DownloadAttachment methods
</verification>

<success_criteria>
- SearchQuery builder constructs valid Zoho search syntax from chainable methods
- `zoh mail messages search` accepts free-text query and/or structured flags (from, subject, after, before, unread, has-attachment)
- `zoh mail messages thread` shows all messages in a thread by filtering folder messages by threadId
- `zoh mail attachments list` shows attachment metadata (name, size, type) for a message
- `zoh mail attachments download` streams binary attachment to disk without loading into memory
- Download auto-detects filename from attachment metadata when --output not specified
- Human-readable byte formatting for attachment sizes
- All output modes (JSON, plain, rich) work correctly
- Error handling follows CLIError pattern with appropriate exit codes
</success_criteria>

<output>
After completion, create `.planning/phases/04-mail-read-operations/04-02-SUMMARY.md`
</output>
