---
phase: 01-foundation-authentication
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - main.go
  - go.mod
  - go.sum
  - internal/cli/cli.go
  - internal/cli/globals.go
  - internal/config/config.go
  - internal/config/regions.go
  - internal/config/xdg.go
  - internal/output/formatter.go
  - internal/output/table.go
  - internal/output/errors.go
  - internal/secrets/store.go
autonomous: true

must_haves:
  truths:
    - "`go build ./...` compiles a working `zoh` binary with Kong CLI framework"
    - "`zoh --help` displays top-level command tree (auth, config subgroups)"
    - "Config loads from XDG-compliant path (~/.config/zoh/config.json5) with defaults when file absent"
    - "Region map resolves all 8 Zoho data centers to correct accounts/API/mail base URLs"
    - "Output formatter renders data correctly in JSON (stdout), plain (TSV to stdout), and rich (table to stdout) modes"
    - "Errors and hints go to stderr, data goes to stdout, exit codes are defined constants"
  artifacts:
    - path: "main.go"
      provides: "CLI entrypoint -- kong.Parse, ctx.Run"
      contains: "kong.Parse"
    - path: "internal/cli/cli.go"
      provides: "Kong root struct with Auth and Config subcommands, BeforeApply hook"
      contains: "BeforeApply"
    - path: "internal/config/config.go"
      provides: "Config struct with Load/Save, JSON5 parsing"
      exports: ["Config", "Load", "Save"]
    - path: "internal/config/regions.go"
      provides: "Region-to-endpoint mapping for all 8 Zoho DCs"
      contains: "RegionConfig"
    - path: "internal/output/formatter.go"
      provides: "Formatter interface with JSON, plain, rich implementations"
      exports: ["Formatter", "New"]
    - path: "internal/secrets/store.go"
      provides: "Store interface for credential storage"
      exports: ["Store"]
  key_links:
    - from: "main.go"
      to: "internal/cli/cli.go"
      via: "kong.Parse(&cli)"
      pattern: "kong\\.Parse"
    - from: "internal/cli/cli.go"
      to: "internal/config/config.go"
      via: "BeforeApply loads config and binds to Kong context"
      pattern: "config\\.Load"
    - from: "internal/cli/cli.go"
      to: "internal/output/formatter.go"
      via: "BeforeApply creates formatter and binds to Kong context"
      pattern: "output\\.New"
---

<objective>
Scaffold the zoh CLI project: Go module, Kong CLI framework with command tree skeleton, XDG-compliant config system with JSON5 and region mapping, output formatter framework (JSON/plain/rich), and exit code constants. This creates the foundation every subsequent plan builds on.

Purpose: All Phase 1 plans (auth, commands) and all future phases depend on the CLI skeleton, config system, and output formatting. Nothing can be built without this foundation.
Output: Compilable Go binary (`zoh`) with `--help`, config load/save, three output modes, region resolution, and defined exit codes.
</objective>

<execution_context>
@/home/semmy/.claude/get-shit-done/workflows/execute-plan.md
@/home/semmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-authentication/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Go module, Kong CLI skeleton, and config system</name>
  <files>
    main.go
    go.mod
    internal/cli/cli.go
    internal/cli/globals.go
    internal/config/config.go
    internal/config/regions.go
    internal/config/xdg.go
  </files>
  <action>
1. Initialize Go module:
   - `go mod init github.com/semmy-space/zoh` (match GitHub org pattern)
   - Target Go 1.22+ (for range-over-int and other modern features)

2. Create `main.go`:
   - Import `internal/cli`
   - `kong.Parse(&cli.CLI{})` with app name "zoh", description "Zoho CLI for Admin and Mail operations"
   - Call `ctx.Run()` passing bound dependencies
   - Handle errors: print to stderr via output helpers, exit with correct code

3. Create `internal/cli/globals.go` -- Global flags struct:
   ```go
   type Globals struct {
       Region  string `help:"Zoho region" default:"" enum:"us,eu,in,au,jp,ca,sa,uk," env:"ZOH_REGION"`
       Output  string `help:"Output format" default:"auto" enum:"json,plain,rich,auto" short:"o" env:"ZOH_OUTPUT"`
       Verbose bool   `help:"Verbose output" short:"v" env:"ZOH_VERBOSE"`
   }
   ```
   - Region default is empty string (resolved from config or defaults to "us")
   - Output "auto" detects TTY: if stdout is TTY -> rich, else -> plain. --json forces JSON.
   - Expose `ResolvedOutput() string` method that checks os.Stdout for TTY

4. Create `internal/cli/cli.go` -- Kong root struct:
   ```go
   type CLI struct {
       Globals
       Auth   AuthCmd   `cmd:"" help:"Authentication commands"`
       Config ConfigCmd `cmd:"" help:"Configuration commands"`
       Version VersionCmd `cmd:"" help:"Show version information"`
   }
   ```
   - AuthCmd and ConfigCmd are placeholder structs with stub subcommands for now (login, logout, list under auth; get, set, unset, list, path under config). They will be implemented in Plan 03.
   - BeforeApply hook: loads config via `config.Load()`, resolves region (CLI flag > config > "us" default), creates output formatter via `output.New(resolvedOutput)`, binds config + formatter to kong context via `ctx.Bind()`
   - Version command prints build version (use `ldflags` pattern: `var version = "dev"`)

5. Create `internal/config/xdg.go`:
   - Use `adrg/xdg` for paths
   - `ConfigDir() string` -> `xdg.ConfigHome + "/zoh"` (typically `~/.config/zoh/`)
   - `ConfigPath() string` -> `ConfigDir() + "/config.json5"`
   - `CacheDir() string` -> `xdg.CacheHome + "/zoh"` (for token cache in Plan 02)
   - `DataDir() string` -> `xdg.DataHome + "/zoh"` (for future use)

6. Create `internal/config/config.go`:
   - Config struct with JSON5 tags: Region, ClientID, ClientSecret, OrgID, AccountID, DefaultOutput
   - `Load() (*Config, error)` -- reads from XDG path, returns defaults if file missing (Region: "", which means "not set"). Use `yosuke-furukawa/json5` for parsing.
   - `Save() error` -- marshal to JSON (not JSON5 for writing -- JSON is valid JSON5), write to XDG path with 0600 permissions, create parent dir with 0700 if needed
   - `Get(key string) (string, error)` -- reflection-based or map-based key lookup for `config get`
   - `Set(key, value string) error` -- set key value, then Save
   - `Unset(key string) error` -- set key to zero value, then Save

7. Create `internal/config/regions.go`:
   - RegionConfig struct: AccountsServer, APIBase, MailBase strings
   - Map of all 8 Zoho regions:
     - "us": accounts.zoho.com, zohoapis.com, mail.zoho.com
     - "eu": accounts.zoho.eu, zohoapis.eu, mail.zoho.eu
     - "in": accounts.zoho.in, zohoapis.in, mail.zoho.in
     - "au": accounts.zoho.com.au, zohoapis.com.au, mail.zoho.com.au
     - "jp": accounts.zoho.jp, zohoapis.jp, mail.zoho.jp
     - "ca": accounts.zohocloud.ca, zohoapis.ca, mail.zohocloud.ca
     - "sa": accounts.zoho.sa, zohoapis.sa, mail.zoho.sa
     - "uk": accounts.zoho.uk, zohoapis.uk, mail.zoho.uk
   - `GetRegion(name string) (RegionConfig, error)` -- returns config or error for unknown region
   - `ValidRegions() []string` -- returns sorted list of valid region codes

8. Run `go mod tidy` to resolve all dependencies. Ensure `go build ./...` succeeds.
  </action>
  <verify>
Run: `cd /home/semmy/codeprojects/zohod-cli && go build -o zoh ./... && ./zoh --help`
Expected: Binary compiles, help shows "auth" and "config" subcommands with global flags (--region, --output, --verbose).
Run: `go vet ./...` -- no errors.
  </verify>
  <done>
- `go build ./...` compiles without errors
- `./zoh --help` displays auth, config, version subcommands and global flags
- Config loads defaults when no config file exists
- Region map has all 8 Zoho DCs with correct URLs
  </done>
</task>

<task type="auto">
  <name>Task 2: Output formatters, exit codes, and secrets store interface</name>
  <files>
    internal/output/formatter.go
    internal/output/table.go
    internal/output/errors.go
    internal/secrets/store.go
  </files>
  <action>
1. Create `internal/output/formatter.go`:
   - `Formatter` interface with methods:
     - `Print(data any) error` -- renders data to stdout
     - `PrintList(items any, columns []Column) error` -- renders a list as table/TSV/JSON array
     - `PrintError(err error)` -- renders error to stderr
     - `PrintHint(msg string)` -- renders hint/progress to stderr
   - `Column` struct: `Name string`, `Key string` (struct field name or map key), `Width int` (for rich mode)
   - `New(mode string) Formatter` factory -- returns jsonFormatter, plainFormatter, or richFormatter
   - **jsonFormatter**:
     - `Print`: json.NewEncoder(os.Stdout) with 2-space indent
     - `PrintList`: same, but wraps in JSON array
     - `PrintError`: JSON object `{"error": "message"}` to stderr
     - `PrintHint`: JSON object `{"hint": "message"}` to stderr (only in verbose mode, or skip)
   - **plainFormatter**:
     - `Print`: tab-separated key=value pairs, one per line
     - `PrintList`: tab-separated values, one record per line, header row first
     - `PrintError`: "error: message\n" to stderr
     - `PrintHint`: "hint: message\n" to stderr
   - **richFormatter**:
     - Uses muesli/termenv for color profile detection
     - Uses charmbracelet/lipgloss v2 for styling
     - `Print`: styled key-value output with colors
     - `PrintList`: uses table renderer (next file)
     - `PrintError`: red-styled error message to stderr
     - `PrintHint`: dim-styled hint to stderr

2. Create `internal/output/table.go`:
   - `RenderTable(w io.Writer, columns []Column, rows []map[string]string)` for rich mode
   - Use `rodaine/table` for ASCII table rendering with column headers
   - Support configurable column widths from Column struct
   - Truncate long values with "..." when they exceed column width

3. Create `internal/output/errors.go`:
   - Exit code constants (UX-04):
     ```go
     const (
         ExitOK           = 0   // Success
         ExitGeneral      = 1   // General error
         ExitUsage        = 2   // Invalid usage / bad arguments
         ExitAuth         = 3   // Authentication failure
         ExitNotFound     = 4   // Resource not found
         ExitConflict     = 5   // Conflict (resource already exists)
         ExitForbidden    = 6   // Permission denied
         ExitRateLimit    = 75  // Rate limited (EX_TEMPFAIL from sysexits.h)
         ExitTimeout      = 8   // Request timeout
         ExitAPIError     = 9   // Zoho API error (non-specific)
         ExitConfigError  = 10  // Configuration error
         ExitNetworkError = 11  // Network connectivity error
     )
     ```
   - `CLIError` struct implementing `error` interface with `ExitCode int`, `Message string`, `Hint string` (optional user-facing hint)
   - `NewCLIError(code int, msg string) *CLIError`
   - `WithHint(hint string) *CLIError` -- builder method
   - `ExitWithError(formatter Formatter, err error)` -- extracts CLIError if possible, prints via formatter, calls os.Exit with correct code

4. Create `internal/secrets/store.go`:
   - `Store` interface:
     ```go
     type Store interface {
         Get(key string) (string, error)
         Set(key, value string) error
         Delete(key string) error
         List() ([]string, error)
     }
     ```
   - This is the interface only. Keyring and file implementations come in Plan 02.
   - `ErrNotFound` sentinel error for missing keys
   - Service name constant: `const ServiceName = "zoh"`

5. Run `go mod tidy` to ensure all new dependencies resolve.
  </action>
  <verify>
Run: `cd /home/semmy/codeprojects/zohod-cli && go build ./...`
Expected: Compiles without errors. All new packages imported and used.
Run: `go vet ./...` -- no errors.
Manually verify: `internal/output/errors.go` contains all exit code constants listed above.
  </verify>
  <done>
- Three formatter implementations (JSON, plain, rich) compile and implement the Formatter interface
- Exit codes defined as constants covering all error categories (auth, not found, rate limit, etc.)
- CLIError type provides structured errors with exit codes and optional hints
- Secrets Store interface defined with Get/Set/Delete/List methods
- `go build ./...` passes clean
  </done>
</task>

</tasks>

<verification>
1. `go build -o zoh ./...` -- binary compiles
2. `./zoh --help` -- shows auth, config subgroups and global flags
3. `./zoh version` -- prints version string
4. `go vet ./...` -- no warnings
5. Project structure matches research recommendation: main.go, internal/{cli,config,output,secrets}
6. Config loads defaults when no file exists (no crash on fresh system)
7. All 8 Zoho regions defined with correct base URLs
</verification>

<success_criteria>
- Working Go binary that responds to --help, --version
- Config system loads/saves JSON5 from XDG path
- Output formatter supports JSON, plain, rich modes
- Exit codes documented as constants
- Secrets Store interface ready for Plan 02 implementations
- Clean `go build` and `go vet`
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-authentication/01-01-SUMMARY.md`
</output>
