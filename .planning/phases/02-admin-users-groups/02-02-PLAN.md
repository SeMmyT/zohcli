---
phase: 02-admin-users-groups
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - internal/zoho/admin_client.go
  - internal/cli/admin_users.go
  - internal/cli/cli.go
autonomous: true

must_haves:
  truths:
    - "User can run `zoh admin users create` to add a new user to the organization"
    - "User can run `zoh admin users update` to change a user's role"
    - "User can run `zoh admin users activate/deactivate` to enable/disable a user"
    - "User can run `zoh admin users delete` to permanently remove a user (with --confirm flag)"
  artifacts:
    - path: "internal/zoho/admin_client.go"
      provides: "CreateUser, UpdateUserRole, EnableUser, DisableUser, DeleteUser methods"
      contains: "func (ac *AdminClient) CreateUser"
    - path: "internal/cli/admin_users.go"
      provides: "CLI commands for user create, update, activate, deactivate, delete"
      contains: "type AdminUsersCreateCmd struct"
  key_links:
    - from: "internal/cli/admin_users.go"
      to: "internal/zoho/admin_client.go"
      via: "AdminClient mutating methods"
      pattern: "ac\\.CreateUser|ac\\.EnableUser|ac\\.DisableUser|ac\\.DeleteUser"
    - from: "internal/zoho/admin_client.go"
      to: "internal/zoho/types.go"
      via: "Uses CreateUserRequest, UpdateUserRequest, DeleteConfirmation"
      pattern: "CreateUserRequest|UpdateUserRequest"
---

<objective>
Implement user mutation commands: create, update (role), activate, deactivate, and delete, completing all user management requirements.

Purpose: Delivers full user lifecycle management from the terminal, covering ADMIN-USR-03 through ADMIN-USR-06.
Output: Working `zoh admin users create/update/activate/deactivate/delete` commands.
</objective>

<execution_context>
@/home/semmy/.claude/get-shit-done/workflows/execute-plan.md
@/home/semmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-users-groups/02-RESEARCH.md
@.planning/phases/02-admin-users-groups/02-01-SUMMARY.md
@internal/zoho/admin_client.go
@internal/zoho/types.go
@internal/cli/admin_users.go
@internal/cli/cli.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: AdminClient mutating methods for users</name>
  <files>internal/zoho/admin_client.go</files>
  <action>
Add the following methods to AdminClient in admin_client.go:

**CreateUser(ctx, req CreateUserRequest) (*User, error)**
- POST /api/organization/{zoid}/accounts
- Marshal CreateUserRequest as JSON body
- Expect HTTP 201 Created
- Decode response body into UserDetailResponse, return &result.Data
- On non-201: parseErrorResponse

**UpdateUserRole(ctx, zuid int64, newRole string) error**
- PUT /api/organization/{zoid}/accounts
- Body: `{"mode": "changeRole", "zuid": {zuid}, "newRole": "{newRole}"}`
- Use UpdateUserRequest type with Mode="changeRole", ZUID=zuid, NewRole=newRole
- Expect HTTP 200
- On non-200: parseErrorResponse

**EnableUser(ctx, zuid int64) error**
- PUT /api/organization/{zoid}/accounts
- Body: `{"mode": "enableUser", "zuid": {zuid}}`
- Use UpdateUserRequest with Mode="enableUser", ZUID=zuid
- Expect HTTP 200

**DisableUser(ctx, zuid int64, opts DisableUserOpts) error**
- PUT /api/organization/{zoid}/accounts
- Body: `{"mode": "disableUser", "zuid": {zuid}, "blockIncoming": bool, ...}`
- Add `DisableUserOpts` struct to types.go if not already there: BlockIncoming, RemoveMailForward, RemoveGroupMembership, RemoveAlias bools
- Build request body by combining mode + zuid + opts fields
- Expect HTTP 200

**DeleteUser(ctx, zuid int64) error**
- DELETE /api/organization/{zoid}/accounts/{zuid}
- No request body needed
- Expect HTTP 200
- On non-200: parseErrorResponse

Also add a `DisableUserOpts` struct to types.go (or as an inline struct) with: BlockIncoming, RemoveMailForward, RemoveGroupMembership, RemoveAlias bool fields with json tags and omitempty.

Ensure `go build ./internal/zoho/...` compiles.
  </action>
  <verify>
Run `go build ./internal/zoho/...` — compiles.
Run `go vet ./internal/zoho/...` — no warnings.
  </verify>
  <done>
AdminClient has CreateUser, UpdateUserRole, EnableUser, DisableUser, DeleteUser methods. All compile and use correct HTTP methods, paths, and request body structures with mode parameters.
  </done>
</task>

<task type="auto">
  <name>Task 2: User create/update/activate/deactivate/delete CLI commands</name>
  <files>internal/cli/admin_users.go, internal/cli/cli.go</files>
  <action>
Add the following command structs and Run methods to admin_users.go:

**AdminUsersCreateCmd:**
- Email string `arg:"" help:"Primary email address for the new user"`
- Password string `help:"Initial password (if not set, Zoho sends setup email)" short:"p"`
- FirstName string `help:"First name" short:"f"`
- LastName string `help:"Last name" short:"l"`
- DisplayName string `help:"Display name" short:"d"`
- Role string `help:"Role: member, admin" default:"member" enum:"member,admin" short:"r"`
- Run: build CreateUserRequest from flags, call ac.CreateUser, output created user via fp.Formatter.Print
- On success: print confirmation to stderr ("User created: email@example.com")

**AdminUsersUpdateCmd:**
- Identifier string `arg:"" help:"User ID (zuid) or email address"`
- Role string `help:"New role: member, admin" required:"" enum:"member,admin" short:"r"`
- Run: resolve identifier to zuid (if email, use GetUserByEmail first), call ac.UpdateUserRole
- On success: print confirmation to stderr ("User role updated: member -> admin")

**AdminUsersActivateCmd:**
- Identifier string `arg:"" help:"User ID (zuid) or email address"`
- Run: resolve identifier to zuid, call ac.EnableUser
- On success: print confirmation to stderr ("User activated: email@example.com")

**AdminUsersDeactivateCmd:**
- Identifier string `arg:"" help:"User ID (zuid) or email address"`
- BlockIncoming bool `help:"Block incoming mail for deactivated user"`
- RemoveForward bool `help:"Remove mail forwarding rules"`
- RemoveGroups bool `help:"Remove from all groups"`
- RemoveAliases bool `help:"Remove email aliases"`
- Run: resolve identifier to zuid, build DisableUserOpts from flags, call ac.DisableUser
- On success: print confirmation to stderr ("User deactivated: email@example.com")

**AdminUsersDeleteCmd:**
- Identifier string `arg:"" help:"User ID (zuid) or email address"`
- Confirm bool `help:"Confirm permanent deletion (required)" required:""`
- Run: resolve identifier to zuid, require --confirm flag (print error with explanation if missing), call ac.DeleteUser
- On success: print confirmation to stderr ("User deleted permanently: email@example.com")
- IMPORTANT: deletion is permanent. The --confirm flag is required to prevent accidents.

Helper function `resolveUserID(ac *zoho.AdminClient, identifier string) (int64, error)`:
- If identifier contains "@": call ac.GetUserByEmail, return user.ZUID
- Else: parse as int64, return directly
- This avoids duplicating resolution logic across commands

Update cli.go AdminUsersCmd to register all new subcommands:
```go
type AdminUsersCmd struct {
    List       AdminUsersListCmd       `cmd:"" help:"List organization users"`
    Get        AdminUsersGetCmd        `cmd:"" help:"Get user details"`
    Create     AdminUsersCreateCmd     `cmd:"" help:"Create a new user"`
    Update     AdminUsersUpdateCmd     `cmd:"" help:"Update user role"`
    Activate   AdminUsersActivateCmd   `cmd:"" help:"Activate a user account"`
    Deactivate AdminUsersDeactivateCmd `cmd:"" help:"Deactivate a user account"`
    Delete     AdminUsersDeleteCmd     `cmd:"" help:"Delete a user permanently"`
}
```

Error handling pattern (consistent with auth.go):
- Auth failures: ExitAuth
- API errors (4xx/5xx): ExitAPIError (add this exit code constant if missing — value 5, between ExitConfigError=4 and ExitTimeout=6)
- Missing --confirm on delete: ExitUsage with clear message
  </action>
  <verify>
Run `go build ./...` — full project compiles.
Run `go vet ./...` — no warnings.
Run `./zoh admin users --help` — shows all 7 subcommands (list, get, create, update, activate, deactivate, delete).
Run `./zoh admin users create --help` — shows email arg, --password, --first-name, --last-name, --role flags.
Run `./zoh admin users delete --help` — shows --confirm required flag.
  </verify>
  <done>
All user mutation commands registered and compile. Create accepts email + optional flags, update changes role, activate/deactivate toggles user state, delete requires --confirm. All commands resolve email-or-ID identifiers and output results in all three modes.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` — entire project compiles
2. `go vet ./...` — no warnings
3. `./zoh admin users --help` — shows all 7 subcommands
4. `./zoh admin users create --help` — correct flags
5. `./zoh admin users update --help` — shows --role required flag
6. `./zoh admin users activate --help` — shows identifier argument
7. `./zoh admin users deactivate --help` — shows deactivation options
8. `./zoh admin users delete --help` — shows --confirm required
</verification>

<success_criteria>
- AdminClient has CreateUser, UpdateUserRole, EnableUser, DisableUser, DeleteUser methods
- Each method uses correct HTTP method, endpoint path, and request body with mode parameter
- CLI commands: create (with email + optional fields), update (role change), activate, deactivate (with options), delete (requires --confirm)
- Email-or-ID resolution works in all mutation commands
- Error messages are helpful (missing --confirm explains why, API errors show description)
- Delete command requires explicit --confirm to prevent accidental permanent deletion
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-users-groups/02-02-SUMMARY.md`
</output>
