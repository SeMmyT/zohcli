---
phase: 02-admin-users-groups
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/zoho/types.go
  - internal/zoho/admin_client.go
  - internal/zoho/pagination.go
  - internal/cli/admin_users.go
  - internal/cli/cli.go
autonomous: true

must_haves:
  truths:
    - "User can run `zoh admin users list` and see paginated org users"
    - "User can run `zoh admin users get <id-or-email>` and see detailed user info"
    - "Admin client automatically resolves organization ID without user input"
    - "Pagination transparently fetches all pages when listing users"
  artifacts:
    - path: "internal/zoho/types.go"
      provides: "API request/response type definitions for users, groups, and org"
      contains: "type User struct"
    - path: "internal/zoho/admin_client.go"
      provides: "AdminClient with cached zoid, user list/get methods"
      contains: "type AdminClient struct"
    - path: "internal/zoho/pagination.go"
      provides: "Generic PageIterator for offset-based pagination"
      contains: "type PageIterator"
    - path: "internal/cli/admin_users.go"
      provides: "CLI commands for user list and get"
      contains: "type AdminUsersListCmd struct"
  key_links:
    - from: "internal/cli/admin_users.go"
      to: "internal/zoho/admin_client.go"
      via: "AdminClient.ListUsers and AdminClient.GetUser"
      pattern: "ac\\.ListUsers|ac\\.GetUser"
    - from: "internal/zoho/admin_client.go"
      to: "internal/zoho/client.go"
      via: "Embeds *Client for HTTP requests"
      pattern: "client\\.Do"
    - from: "internal/zoho/admin_client.go"
      to: "internal/zoho/pagination.go"
      via: "Uses PageIterator for list operations"
      pattern: "NewPageIterator"
---

<objective>
Build the admin API client layer with organization ID resolution, offset-based pagination abstraction, API type definitions, and implement user list/get CLI commands.

Purpose: Establishes the reusable admin infrastructure (AdminClient, PageIterator, types) that all Phase 2 commands depend on, and delivers the first two user requirements (list + get).
Output: Working `zoh admin users list` and `zoh admin users get` commands with proper output formatting.
</objective>

<execution_context>
@/home/semmy/.claude/get-shit-done/workflows/execute-plan.md
@/home/semmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-admin-users-groups/02-RESEARCH.md
@.planning/phases/01-foundation-authentication/01-01-SUMMARY.md
@.planning/phases/01-foundation-authentication/01-03-SUMMARY.md
@internal/zoho/client.go
@internal/cli/cli.go
@internal/output/formatter.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: API types, AdminClient with org ID resolution, and PageIterator</name>
  <files>internal/zoho/types.go, internal/zoho/admin_client.go, internal/zoho/pagination.go</files>
  <action>
Create three files in internal/zoho/:

**types.go** — API request/response structs with JSON tags:
- `OrgResponse` with nested Status (Code int, Description string) and Data (OrganizationID int64 `json:"zoid"`, CompanyName, UserCount, GroupCount)
- `User` struct: ZUID int64 `json:"zuid"`, AccountID int64 `json:"accountId"`, EmailAddress, FirstName, LastName, DisplayName, Role, MailboxStatus string, UsedStorage/PlanStorage int64, TFAEnabled/IMAPAccessEnabled/POPAccessEnabled bool, LastLogin int64 (unix timestamp)
- `UserListResponse` with Status and Data []User
- `UserDetailResponse` with Status and Data User (for single user get)
- `CreateUserRequest`: PrimaryEmailAddress, Password, FirstName, LastName, DisplayName, Role, Country, Language, TimeZone string, OneTimePassword bool, GroupMailList []string
- `UpdateUserRequest`: Mode string `json:"mode"`, ZUID int64, plus fields for role changes (NewRole string `json:"newRole,omitempty"`)
- `Group` struct: ZGID int64 `json:"zgid"`, GroupName, GroupEmailAddress, Description string, MembersCount int
- `GroupListResponse` with Status and Data []Group
- `GroupDetailResponse` with Status and Data Group
- `GroupMember` struct: MemberEmailID string, Role string, ZUID int64
- `CreateGroupRequest`: GroupName, GroupEmailAddress, Description string, AdminsEmailList []string, MembersEmailList []string
- `AddGroupMembersRequest`: Mode string (always "addMailGroupMember"), MailGroupMemberList []GroupMemberToAdd
- `GroupMemberToAdd`: MemberEmailID string, Role string
- `RemoveGroupMembersRequest`: Mode string (always "removeMailGroupMember"), MailGroupMemberList []GroupMemberToRemove
- `GroupMemberToRemove`: MemberEmailID string
- `DeleteConfirmation`: Mode string (always "deleteUser" or used for groups)
- Generic `APIError` struct for error responses: Status (Code int, Description string), Data struct with MoreInfo string

**admin_client.go** — AdminClient wrapping zoho.Client:
- `AdminClient` struct with `client *Client` and `zoid int64` fields
- `NewAdminClient(cfg *config.Config, tokenSource oauth2.TokenSource) (*AdminClient, error)` — creates Client via NewClient, then calls getOrganizationID to cache zoid
- `getOrganizationID(ctx context.Context) (int64, error)` — GET /api/organization/ via client.Do, decode OrgResponse, return zoid
- `ListUsers(ctx context.Context, start, limit int) ([]User, error)` — GET /api/organization/{zoid}/accounts?start={start}&limit={limit}, decode UserListResponse
- `GetUser(ctx context.Context, accountID int64) (*User, error)` — GET /api/organization/{zoid}/accounts/{accountID}, decode UserDetailResponse
- `GetUserByEmail(ctx context.Context, email string) (*User, error)` — iterate pages via ListUsers until email match found, return error if not found
- `parseErrorResponse(resp *http.Response) error` — reads body, tries to decode APIError, returns formatted error with status code and description
- Use client.Do (not DoMail) for all admin endpoints — the API base URL (/api/organization/...) goes through the standard API endpoint

**pagination.go** — Generic offset-based pagination:
- `PageIterator[T any]` struct: fetchFunc func(start, limit int) ([]T, error), pageSize int, current int, done bool
- `NewPageIterator[T any](fetchFunc, pageSize int) *PageIterator[T]`
- `FetchAll() ([]T, error)` — fetches all pages until len(results) < pageSize, returns combined slice
- `FetchPage(start int) ([]T, error)` — fetches single page (for paginated CLI output)
- Default page size: 50

Ensure all three files compile: `go build ./internal/zoho/...`
  </action>
  <verify>
Run `go build ./internal/zoho/...` — must compile with no errors.
Run `go vet ./internal/zoho/...` — no warnings.
  </verify>
  <done>
AdminClient, PageIterator, and all API types compile. AdminClient has methods: NewAdminClient, ListUsers, GetUser, GetUserByEmail. PageIterator supports FetchAll and FetchPage.
  </done>
</task>

<task type="auto">
  <name>Task 2: User list and get CLI commands with output formatting</name>
  <files>internal/cli/admin_users.go, internal/cli/cli.go</files>
  <action>
**admin_users.go** — User list and get commands:

`AdminUsersListCmd` struct:
- Limit int `help:"Maximum users to show per page" short:"l" default:"50"`
- All bool `help:"Fetch all users (no pagination limit)" short:"a"`
- Run method: creates AdminClient (needs config + token source from auth.NewTokenCache), calls ListUsers/FetchAll, outputs via fp.Formatter.PrintList with columns: Email, Name (DisplayName), Role, Status (MailboxStatus), ZUID
- For `--all`: use PageIterator.FetchAll()
- Without `--all`: fetch single page with Limit

`AdminUsersGetCmd` struct:
- Identifier string `arg:"" help:"User ID (zuid) or email address"`
- Run method: if Identifier contains "@", use GetUserByEmail; else parse as int64 and use GetUser. Output via fp.Formatter.Print with full user details.

Wire AdminClient creation into a helper function in admin_users.go:
```go
func newAdminClient(cfg *config.Config) (*zoho.AdminClient, error) {
    store, err := secrets.NewStore()
    if err != nil { return nil, err }
    tokenCache, err := auth.NewTokenCache(cfg, store)
    if err != nil { return nil, err }
    return zoho.NewAdminClient(cfg, tokenCache)
}
```
This pattern mirrors auth.go's approach (secrets.NewStore -> auth.NewTokenCache -> client).

Error handling: wrap all errors in output.CLIError with appropriate exit codes (ExitAuth for auth failures, ExitAPIError for API errors, ExitGeneral for others).

**cli.go** — Register admin command tree:
- Add `Admin AdminCmd` to CLI struct with `cmd:"" help:"Admin operations"`
- `AdminCmd` struct with `Users AdminUsersCmd` subcommand
- `AdminUsersCmd` struct with `List AdminUsersListCmd` and `Get AdminUsersGetCmd` subcommands

This creates the command hierarchy: `zoh admin users list` and `zoh admin users get <id-or-email>`

Column definitions for user list:
```go
columns := []output.Column{
    {Name: "Email", Key: "EmailAddress"},
    {Name: "Name", Key: "DisplayName"},
    {Name: "Role", Key: "Role"},
    {Name: "Status", Key: "MailboxStatus"},
    {Name: "ZUID", Key: "ZUID"},
}
```

Ensure `go build ./...` passes and `./zoh admin users --help` shows list/get subcommands.
  </action>
  <verify>
Run `go build ./...` — full project compiles.
Run `go vet ./...` — no warnings.
Run `./zoh admin --help` — shows "users" subcommand.
Run `./zoh admin users --help` — shows "list" and "get" subcommands.
Run `./zoh admin users list --help` — shows --limit, --all flags.
Run `./zoh admin users get --help` — shows identifier argument.
  </verify>
  <done>
`zoh admin users list` and `zoh admin users get` commands registered, compile, and show correct help. Commands create AdminClient, call API methods, and format output via Formatter.PrintList/Print in all three output modes.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` — entire project compiles
2. `go vet ./...` — no warnings
3. `./zoh admin users --help` — shows list and get subcommands
4. `./zoh admin users list --help` — shows --limit and --all flags
5. `./zoh admin users get --help` — shows identifier argument
6. AdminClient, PageIterator, and all types exist in internal/zoho/
</verification>

<success_criteria>
- AdminClient wraps Client with cached zoid and has ListUsers, GetUser, GetUserByEmail methods
- PageIterator provides generic offset-based pagination (FetchAll, FetchPage)
- All API types (User, Group, requests/responses) defined with proper JSON tags
- `zoh admin users list` shows paginated users with Email, Name, Role, Status, ZUID columns
- `zoh admin users get <id-or-email>` shows full user details
- Error responses parsed into readable CLIError messages
- All output modes (JSON, plain, rich) work for both list and get commands
</success_criteria>

<output>
After completion, create `.planning/phases/02-admin-users-groups/02-01-SUMMARY.md`
</output>
