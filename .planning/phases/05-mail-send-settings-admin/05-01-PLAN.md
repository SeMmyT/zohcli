---
phase: 05-mail-send-settings-admin
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/zoho/mail_send.go
  - internal/zoho/mail_types.go
  - internal/cli/mail_send.go
  - internal/cli/cli.go
autonomous: true

must_haves:
  truths:
    - "User can compose and send a new email with to/cc/bcc, subject, and body"
    - "User can send HTML or plain text email body"
    - "User can reply, reply-all, and forward a message"
    - "User can attach local files when sending email"
  artifacts:
    - path: "internal/zoho/mail_send.go"
      provides: "Send email methods, attachment upload, send types"
      exports: ["SendEmail", "ReplyToEmail", "ReplyAllToEmail", "ForwardEmail", "UploadAttachment"]
    - path: "internal/cli/mail_send.go"
      provides: "CLI commands for compose, reply, forward"
      exports: ["MailSendComposeCmd", "MailSendReplyCmd", "MailSendForwardCmd"]
  key_links:
    - from: "internal/cli/mail_send.go"
      to: "internal/zoho/mail_send.go"
      via: "MailClient send methods"
      pattern: "mc\\.SendEmail|mc\\.ReplyToEmail|mc\\.ForwardEmail"
    - from: "internal/zoho/mail_send.go"
      to: "internal/zoho/client.go"
      via: "DoMail for send requests, DoMailRaw for attachment upload"
      pattern: "mc\\.client\\.DoMail|mc\\.client\\.doMailRequest"
---

<objective>
Implement email send operations: compose new email, reply, reply-all, forward, with attachment upload support.

Purpose: Users can send email entirely from the terminal, including replies and forwards with file attachments -- the core write operation for mail.
Output: MailClient send methods (mail_send.go), send types (mail_types.go), CLI send commands (mail_send.go), updated command tree (cli.go)
</objective>

<execution_context>
@/home/semmy/.claude/get-shit-done/workflows/execute-plan.md
@/home/semmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-mail-read-operations/04-01-SUMMARY.md
@.planning/phases/04-mail-read-operations/04-02-SUMMARY.md
@.planning/phases/05-mail-send-settings-admin/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Send types, attachment upload, and MailClient send methods</name>
  <files>internal/zoho/mail_send.go, internal/zoho/mail_types.go</files>
  <action>
Create `internal/zoho/mail_send.go` with all send-related methods on MailClient:

**Types (add to mail_types.go):**
- `SendEmailRequest` struct: FromAddress, ToAddress, CcAddress (omitempty), BccAddress (omitempty), Subject, Content, MailFormat (omitempty, "html" or "plaintext"), Action (omitempty, "reply"/"replyall"/"forward"), Attachments []AttachmentReference (omitempty). All string fields with json tags.
- `AttachmentReference` struct: StoreName, AttachmentName, AttachmentPath (all string, json tags).
- `AttachmentUploadResponse` struct: Status{Code int, Description string}, Data{StoreName, AttachmentName, AttachmentPath string}. Standard Zoho response wrapper.
- `SendEmailResponse` struct: Status{Code int, Description string}. Standard Zoho response wrapper.

**Methods in mail_send.go:**

1. `UploadAttachment(ctx, filePath string) (*AttachmentReference, error)`:
   - Open file with `os.Open`, defer close
   - Extract filename with `filepath.Base`
   - Build URL manually: `mc.client.region.MailBase + fmt.Sprintf("/api/accounts/%s/messages/attachments?fileName=%s", mc.accountID, url.QueryEscape(fileName))`
   - Create `http.NewRequestWithContext` with POST method and file as body
   - CRITICAL: Set `Content-Type: application/octet-stream` (NOT multipart/form-data, NOT application/json)
   - Execute via `mc.client.httpClient.Do(req)` directly (bypass doRequest which sets application/json)
   - Parse AttachmentUploadResponse, return &AttachmentReference{StoreName, AttachmentName, AttachmentPath}
   - Handle non-200 status code with parseErrorResponse

2. `SendEmail(ctx, req *SendEmailRequest) error`:
   - Path: `/api/accounts/{accountId}/messages`
   - JSON marshal req, POST via mc.client.DoMail
   - Parse SendEmailResponse, check Status.Code == 200

3. `ReplyToEmail(ctx, messageID string, req *SendEmailRequest) error`:
   - Set req.Action = "reply"
   - Path: `/api/accounts/{accountId}/messages/{messageId}`
   - POST via mc.client.DoMail, parse response

4. `ReplyAllToEmail(ctx, messageID string, req *SendEmailRequest) error`:
   - Set req.Action = "replyall"
   - Same endpoint pattern as ReplyToEmail

5. `ForwardEmail(ctx, messageID string, req *SendEmailRequest) error`:
   - Set req.Action = "forward"
   - Same endpoint pattern as ReplyToEmail

6. `sendEmailRequest(ctx, path string, req *SendEmailRequest) error`:
   - Private helper shared by Send/Reply/ReplyAll/Forward
   - Marshal JSON, POST via DoMail, parse response, check status code

Follow existing MailClient patterns:
- Use `mc.client.DoMail` for all JSON API calls (sets Content-Type: application/json automatically)
- Use direct `mc.client.httpClient.Do` for attachment upload (needs Content-Type: application/octet-stream)
- Error handling via `mc.parseErrorResponse`
- accountID from `mc.accountID` cached field
  </action>
  <verify>
`go build ./...` compiles successfully.
`go vet ./...` shows no warnings.
Grep for SendEmail, UploadAttachment, ReplyToEmail, ForwardEmail in mail_send.go confirms all methods exist.
Grep for SendEmailRequest, AttachmentReference in mail_types.go confirms types exist.
  </verify>
  <done>
MailClient has SendEmail, ReplyToEmail, ReplyAllToEmail, ForwardEmail, and UploadAttachment methods.
All send types (SendEmailRequest, AttachmentReference, AttachmentUploadResponse, SendEmailResponse) are defined in mail_types.go.
Attachment upload uses application/octet-stream Content-Type bypassing default JSON header.
  </done>
</task>

<task type="auto">
  <name>Task 2: Send CLI commands (compose, reply, forward) with attachment support</name>
  <files>internal/cli/mail_send.go, internal/cli/cli.go</files>
  <action>
Create `internal/cli/mail_send.go` with send commands:

**MailSendComposeCmd:**
- Kong struct tags: `--to` (required string), `--cc` (optional string), `--bcc` (optional string), `--subject` (required string), `--body` (required string), `--html` (bool flag, default false for plaintext), `--attach` ([]string, repeatable flag for file paths)
- Run: Create MailClient via newMailClient(cfg). If --attach provided, upload each file via mc.UploadAttachment, collect []AttachmentReference. Build SendEmailRequest with all fields. If --html, set MailFormat="html" else "plaintext". Call mc.SendEmail. Print confirmation to os.Stderr ("Email sent to {to}"). Return nil.

**MailSendReplyCmd:**
- Kong struct tags: `MessageID` arg (required), `--folder` (required string), `--body` (required string), `--html` (bool flag), `--attach` ([]string, repeatable), `--all` (bool flag for reply-all)
- Run: Create MailClient. Fetch original message metadata via mc.GetMessageMetadata to get sender/recipients. Upload attachments if provided. Build SendEmailRequest: ToAddress = original FromAddress, Subject = "Re: " + original Subject. If --all, set CcAddress to original ToAddress + CcAddress (concatenate non-empty with comma). Call mc.ReplyToEmail or mc.ReplyAllToEmail based on --all flag. Print confirmation to os.Stderr.

**MailSendForwardCmd:**
- Kong struct tags: `MessageID` arg (required), `--folder` (required string), `--to` (required string), `--body` (optional string, defaults to empty), `--html` (bool flag), `--attach` ([]string, repeatable)
- Run: Create MailClient. Fetch original message metadata for subject. Upload attachments if provided. Build SendEmailRequest: ToAddress = --to, Subject = "Fwd: " + original Subject. Call mc.ForwardEmail. Print confirmation to os.Stderr.

**Helper: resolveFolderID(mc, folderName string) (string, error):**
- Try mc.GetFolderByName first, return folder.FolderID
- If not found, treat input as literal folder ID
- Same pattern used in mail_messages.go (extract or duplicate the helper)

**Update cli.go:**
- Add `Send MailSendCmd` field to `MailCmd` struct
- Create `MailSendCmd` struct with: `Compose MailSendComposeCmd`, `Reply MailSendReplyCmd`, `Forward MailSendForwardCmd`

Command hierarchy:
- `zoh mail send compose --to user@example.com --subject "Hello" --body "Hi there" [--html] [--cc X] [--bcc X] [--attach file1.pdf --attach file2.jpg]`
- `zoh mail send reply <message-id> --folder Inbox --body "Thanks" [--all] [--html] [--attach file.pdf]`
- `zoh mail send forward <message-id> --folder Inbox --to user@example.com [--body "FYI"] [--html] [--attach file.pdf]`

Follow existing CLI patterns:
- Use newMailClient(cfg) for client creation
- Use output.CLIError for error returns
- Confirmation messages to os.Stderr
- Folder resolution via GetFolderByName fallback
  </action>
  <verify>
`go build ./...` compiles successfully.
`go vet ./...` shows no warnings.
`./zoh mail send compose --help` shows --to, --subject, --body, --html, --cc, --bcc, --attach flags.
`./zoh mail send reply --help` shows message-id arg and --folder, --body, --html, --attach, --all flags.
`./zoh mail send forward --help` shows message-id arg and --folder, --to, --body, --html, --attach flags.
  </verify>
  <done>
Users can compose new email, reply (single/all), and forward messages via CLI.
Attachment upload integrated into all send commands via --attach flag.
All three send commands show correct help with expected flags and arguments.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` -- entire project compiles
2. `go vet ./...` -- no warnings
3. `./zoh mail send --help` -- shows compose, reply, forward subcommands
4. `./zoh mail send compose --help` -- shows all expected flags
5. `./zoh mail send reply --help` -- shows message-id arg and all expected flags
6. `./zoh mail send forward --help` -- shows message-id arg and all expected flags
7. Grep for UploadAttachment in mail_send.go confirms attachment upload with application/octet-stream
</verification>

<success_criteria>
- MailClient has complete send API: SendEmail, ReplyToEmail, ReplyAllToEmail, ForwardEmail, UploadAttachment
- CLI commands for compose, reply (with --all for reply-all), and forward are registered and show correct help
- Attachment upload uses two-step workflow (upload first, reference in send request)
- Content-Type is application/octet-stream for attachment uploads (NOT multipart/form-data)
- All send types defined in mail_types.go following existing response wrapper pattern
</success_criteria>

<output>
After completion, create `.planning/phases/05-mail-send-settings-admin/05-01-SUMMARY.md`
</output>
