---
phase: 05-mail-send-settings-admin
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - internal/zoho/mail_settings.go
  - internal/zoho/mail_types.go
  - internal/cli/mail_settings.go
  - internal/cli/cli.go
autonomous: true

must_haves:
  truths:
    - "User can list and create email signatures"
    - "User can view and update vacation auto-reply settings"
    - "User can view and update display name"
    - "User can view forwarding settings"
  artifacts:
    - path: "internal/zoho/mail_settings.go"
      provides: "Settings methods on MailClient for signatures, vacation, display name, forwarding"
      exports: ["ListSignatures", "AddSignature", "AddVacationReply", "DisableVacationReply", "UpdateDisplayName", "GetForwardSettings"]
    - path: "internal/cli/mail_settings.go"
      provides: "CLI commands for mail settings management"
      exports: ["MailSettingsSignaturesListCmd", "MailSettingsSignaturesCreateCmd", "MailSettingsVacationGetCmd", "MailSettingsVacationSetCmd", "MailSettingsVacationDisableCmd", "MailSettingsDisplayNameGetCmd", "MailSettingsDisplayNameSetCmd", "MailSettingsForwardingGetCmd"]
  key_links:
    - from: "internal/cli/mail_settings.go"
      to: "internal/zoho/mail_settings.go"
      via: "MailClient settings methods"
      pattern: "mc\\.ListSignatures|mc\\.AddSignature|mc\\.AddVacationReply|mc\\.UpdateDisplayName"
    - from: "internal/zoho/mail_settings.go"
      to: "internal/zoho/client.go"
      via: "DoMail for settings requests"
      pattern: "mc\\.client\\.DoMail"
---

<objective>
Implement mail settings management: email signatures (list/create), vacation auto-reply (view/set/disable), display name (view/update), and forwarding (view).

Purpose: Users can manage their email settings from the terminal without opening the Zoho web UI.
Output: MailClient settings methods (mail_settings.go), settings types (mail_types.go), CLI settings commands (mail_settings.go), updated command tree (cli.go)
</objective>

<execution_context>
@/home/semmy/.claude/get-shit-done/workflows/execute-plan.md
@/home/semmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-mail-send-settings-admin/05-01-SUMMARY.md
@.planning/phases/05-mail-send-settings-admin/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Settings types and MailClient settings methods</name>
  <files>internal/zoho/mail_settings.go, internal/zoho/mail_types.go</files>
  <action>
**Types (add to mail_types.go):**

- `Signature` struct: ID string `json:"id"`, Name string `json:"name"`, Content string `json:"content"`, Position int `json:"position"` (0=below quoted, 1=above quoted), AssignUsers string `json:"assignUsers,omitempty"` (comma-separated emails).
- `SignatureListResponse`: Standard Zoho wrapper (Status{Code,Description}, Data []Signature).
- `SignatureCreateResponse`: Standard Zoho wrapper (Status{Code,Description}, Data struct{ID string `json:"id"`, Name string `json:"name"`}).
- `VacationReply` struct: FromDate string (MM/DD/YYYY HH:MM:SS), ToDate string, SendingInt int (reply interval minutes), Subject string, Content string, SendTo string ("all"/"contacts"/"noncontacts"/"org"/"nonOrgAll").
- `AccountDetails` struct: AccountDisplayName string `json:"accountDisplayName"`, EmailAddress string `json:"emailAddress"`, VacationResponse json.RawMessage `json:"vacationResponse,omitempty"` (for GET), ForwardDetails json.RawMessage `json:"forwardDetails,omitempty"` (for GET).
- `AccountDetailsResponse`: Standard Zoho wrapper (Status{Code,Description}, Data AccountDetails).
- `ForwardSettings` struct: Enabled bool `json:"enabled"`, ForwardTo string `json:"forwardTo"`, KeepCopy bool `json:"keepCopy"`.

**Methods in mail_settings.go (on MailClient):**

1. `ListSignatures(ctx) ([]Signature, error)`:
   - GET `/api/accounts/signature` via mc.client.DoMail
   - Parse SignatureListResponse, return Data

2. `AddSignature(ctx, sig *Signature) (string, error)`:
   - Build request body map: name, content, position. Add assignUsers if non-empty.
   - POST `/api/accounts/signature` via mc.client.DoMail
   - Parse SignatureCreateResponse, return Data.ID

3. `GetAccountDetails(ctx) (*AccountDetails, error)`:
   - GET `/api/accounts/{accountId}` via mc.client.DoMail
   - Parse AccountDetailsResponse, return &Data
   - Used by vacation get, display name get, forwarding get

4. `AddVacationReply(ctx, vacation *VacationReply) error`:
   - Build request body: mode "addVacationReply", vacationResponse map with fromDate, toDate, sendingInt, subject, content, sendTo
   - PUT `/api/accounts/{accountId}` via mc.client.DoMail
   - Parse status response, check Code == 200

5. `DisableVacationReply(ctx) error`:
   - Build request body: mode "disableVacationReply"
   - PUT `/api/accounts/{accountId}` via mc.client.DoMail

6. `UpdateDisplayName(ctx, displayName string) error`:
   - Build request body: mode "updateDisplayName", displayName field
   - PUT `/api/accounts/{accountId}` via mc.client.DoMail

7. Private helper `updateAccountSettings(ctx, reqBody map[string]interface{}) error`:
   - Common PUT logic for mode-based settings operations
   - Marshal JSON, PUT to `/api/accounts/{accountId}`, parse response, check status

Follow existing patterns:
- All methods on *MailClient
- Use mc.client.DoMail for all requests
- Error handling via mc.parseErrorResponse
- Standard Zoho response wrappers for all types

Note on forwarding: Research shows GET endpoint exists for forward restrictions but CREATE/UPDATE is not well-documented. Implement read-only forwarding view (GetAccountDetails returns forwardDetails). Skip forwarding update commands -- research confidence is LOW for CRUD operations.
  </action>
  <verify>
`go build ./...` compiles successfully.
`go vet ./...` shows no warnings.
Grep for ListSignatures, AddSignature, AddVacationReply, DisableVacationReply, UpdateDisplayName, GetAccountDetails in mail_settings.go confirms all methods exist.
Grep for Signature, VacationReply, ForwardSettings in mail_types.go confirms types exist.
  </verify>
  <done>
MailClient has complete settings API: signature CRUD, vacation reply set/disable, display name update, and account details retrieval.
All settings types defined in mail_types.go.
Mode-based settings operations use updateAccountSettings helper for PUT requests.
  </done>
</task>

<task type="auto">
  <name>Task 2: Settings CLI commands (signatures, vacation, display name, forwarding)</name>
  <files>internal/cli/mail_settings.go, internal/cli/cli.go</files>
  <action>
Create `internal/cli/mail_settings.go` with settings commands:

**Signature commands:**

`MailSettingsSignaturesListCmd`:
- No args/flags required
- Run: newMailClient, mc.ListSignatures, PrintList with columns: Name, Position (format 0="Below Quoted"/1="Above Quoted"), AssignUsers, ID
- Use display struct `SignatureRow` with formatted Position string

`MailSettingsSignaturesCreateCmd`:
- Kong struct: `--name` (required string), `--content` (required string), `--position` (int, default 0, help "0=below quoted, 1=above quoted"), `--assign-users` (optional string, "comma-separated email addresses")
- Run: newMailClient, build Signature struct, mc.AddSignature, print "Created signature {name} (ID: {id})" to os.Stderr

**Vacation commands:**

`MailSettingsVacationGetCmd`:
- No args/flags
- Run: newMailClient, mc.GetAccountDetails, extract and display vacation response data. If VacationResponse is null/empty, print "No vacation reply configured" to os.Stderr. Otherwise unmarshal JSON and display fields.

`MailSettingsVacationSetCmd`:
- Kong struct: `--from` (required string, "MM/DD/YYYY HH:MM:SS"), `--to` (required string, "MM/DD/YYYY HH:MM:SS"), `--subject` (required string), `--content` (required string), `--interval` (int, default 1440, "Reply interval in minutes"), `--send-to` (string, default "all", enum:"all,contacts,noncontacts,org,nonOrgAll")
- Run: Validate date format with time.Parse("01/02/2006 15:04:05", ...) for both --from and --to. newMailClient, build VacationReply, mc.AddVacationReply. Print "Vacation reply enabled ({from} to {to})" to os.Stderr.

`MailSettingsVacationDisableCmd`:
- No args/flags
- Run: newMailClient, mc.DisableVacationReply. Print "Vacation reply disabled" to os.Stderr.

**Display name commands:**

`MailSettingsDisplayNameGetCmd`:
- No args/flags
- Run: newMailClient, mc.GetAccountDetails, print AccountDisplayName. Use PrintDetail for single-item display.

`MailSettingsDisplayNameSetCmd`:
- Kong struct: `Name` arg (required string)
- Run: newMailClient, mc.UpdateDisplayName. Print "Display name updated to {name}" to os.Stderr.

**Forwarding command:**

`MailSettingsForwardingGetCmd`:
- No args/flags
- Run: newMailClient, mc.GetAccountDetails, extract and display forwardDetails. If empty, print "No forwarding configured" to os.Stderr.

**Update cli.go:**
- Add `Settings MailSettingsCmd` field to `MailCmd` struct
- Create `MailSettingsCmd` struct with: `Signatures MailSettingsSignaturesCmd`, `Vacation MailSettingsVacationCmd`, `DisplayName MailSettingsDisplayNameCmd`, `Forwarding MailSettingsForwardingCmd`
- `MailSettingsSignaturesCmd`: List + Create
- `MailSettingsVacationCmd`: Get + Set + Disable
- `MailSettingsDisplayNameCmd` (name:"display-name"): Get + Set
- `MailSettingsForwardingCmd`: Get

Command hierarchy:
- `zoh mail settings signatures list`
- `zoh mail settings signatures create --name "Work" --content "<p>Best,<br>Name</p>" [--position 1] [--assign-users "a@x.com,b@x.com"]`
- `zoh mail settings vacation get`
- `zoh mail settings vacation set --from "02/14/2026 00:00:00" --to "02/21/2026 23:59:59" --subject "OOO" --content "I am away"`
- `zoh mail settings vacation disable`
- `zoh mail settings display-name get`
- `zoh mail settings display-name set "John Doe"`
- `zoh mail settings forwarding get`

Follow existing CLI patterns:
- Use newMailClient(cfg) for client creation
- output.CLIError for errors, os.Stderr for confirmations
- Display structs for formatted output
  </action>
  <verify>
`go build ./...` compiles successfully.
`go vet ./...` shows no warnings.
`./zoh mail settings --help` shows signatures, vacation, display-name, forwarding subcommands.
`./zoh mail settings signatures list --help` shows command help.
`./zoh mail settings signatures create --help` shows --name, --content, --position, --assign-users flags.
`./zoh mail settings vacation set --help` shows --from, --to, --subject, --content, --interval, --send-to flags.
`./zoh mail settings display-name set --help` shows name argument.
`./zoh mail settings forwarding get --help` shows command help.
  </verify>
  <done>
Users can manage signatures (list/create), vacation replies (view/set/disable), display name (view/update), and forwarding (view) from CLI.
All settings commands registered in command tree with correct help text.
Vacation date format validated before API call.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` -- entire project compiles
2. `go vet ./...` -- no warnings
3. `./zoh mail settings --help` -- shows all settings subcommand groups
4. `./zoh mail settings signatures list --help` -- shows command
5. `./zoh mail settings signatures create --help` -- shows all expected flags
6. `./zoh mail settings vacation set --help` -- shows all expected flags
7. `./zoh mail settings vacation disable --help` -- shows command
8. `./zoh mail settings display-name get --help` -- shows command
9. `./zoh mail settings forwarding get --help` -- shows command
</verification>

<success_criteria>
- MailClient has complete settings API: ListSignatures, AddSignature, AddVacationReply, DisableVacationReply, UpdateDisplayName, GetAccountDetails
- CLI commands for signatures (list/create), vacation (get/set/disable), display name (get/set), forwarding (get)
- Mode-based PUT operations use consistent helper pattern
- Vacation date format validated before API call
- Forwarding is read-only (research confidence LOW for update operations)
</success_criteria>

<output>
After completion, create `.planning/phases/05-mail-send-settings-admin/05-02-SUMMARY.md`
</output>
