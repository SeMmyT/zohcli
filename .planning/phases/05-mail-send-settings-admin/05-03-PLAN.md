---
phase: 05-mail-send-settings-admin
plan: 03
type: execute
wave: 3
depends_on: ["05-02"]
files_modified:
  - internal/zoho/mail_admin.go
  - internal/zoho/mail_types.go
  - internal/cli/mail_admin.go
  - internal/cli/cli.go
autonomous: true

must_haves:
  truths:
    - "User can view retention policy settings"
    - "User can view and update spam filter allowlists and blocklists"
    - "User can view mail delivery logs"
  artifacts:
    - path: "internal/zoho/mail_admin.go"
      provides: "Admin policy methods using AdminClient for org-level operations and MailClient for delivery logs"
      exports: ["GetRetentionPolicy", "GetSpamSettings", "UpdateSpamList", "GetDeliveryLogs"]
    - path: "internal/cli/mail_admin.go"
      provides: "CLI commands for mail admin operations"
      exports: ["MailAdminRetentionGetCmd", "MailAdminSpamGetCmd", "MailAdminSpamUpdateCmd", "MailAdminLogsCmd"]
  key_links:
    - from: "internal/cli/mail_admin.go"
      to: "internal/zoho/mail_admin.go"
      via: "Admin policy methods"
      pattern: "GetRetentionPolicy|GetSpamSettings|UpdateSpamList|GetDeliveryLogs"
    - from: "internal/zoho/mail_admin.go"
      to: "internal/zoho/client.go"
      via: "DoMail for org-level admin requests"
      pattern: "client\\.DoMail"
---

<objective>
Implement mail admin operations: retention policy viewing, spam filter settings (view/update allowlists/blocklists), and delivery log viewing.

Purpose: Admins can manage organization-level mail policies from the terminal -- spam control, retention, and delivery monitoring.
Output: Mail admin methods (mail_admin.go), admin types (mail_types.go), CLI admin commands (mail_admin.go), updated command tree (cli.go)
</objective>

<execution_context>
@/home/semmy/.claude/get-shit-done/workflows/execute-plan.md
@/home/semmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-mail-send-settings-admin/05-02-SUMMARY.md
@.planning/phases/05-mail-send-settings-admin/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Mail admin types and methods for spam, retention, and delivery logs</name>
  <files>internal/zoho/mail_admin.go, internal/zoho/mail_types.go</files>
  <action>
**Types (add to mail_types.go):**

- `SpamCategory` type (string) with const enum values. Define user-friendly groups:
  - Email allowlist/blocklist: WhiteListEmail, SpamEmail, RejectEmail, QuarantineEmail, TrustedEmail
  - Domain allowlist/blocklist: WhiteListDomain, SpamDomain, RejectDomain, QuarantineDomain, TrustedDomain, SpamTLD, RejectTLD, QuarantineTLD
  - IP allowlist/blocklist: WhiteListIP, SpamIP, RejectIP, QuarantineIP
- `SpamListEntry` struct: Category SpamCategory, Value string. For display purposes.
- `SpamUpdateRequest` struct: SpamCategory string `json:"spamCategory"`, Value []string `json:"Value"` (note capital V -- matches Zoho API).
- `RetentionPolicy` struct: fields based on API response -- PolicyName string, RetentionDays int, Enabled bool, Scope string. May need json.RawMessage if structure is complex.
- `DeliveryLog` struct: MessageID string, Subject string, FromAddress string, ToAddress string, Status string, SentTime string, DeliveryTime string.
- `DeliveryLogListResponse`: Standard Zoho wrapper (Status{Code,Description}, Data []DeliveryLog).
- Standard response wrappers for spam and retention endpoints.

**Methods in mail_admin.go:**

Create a `MailAdminClient` struct wrapping *Client with cached zoid (organization ID). Follow AdminClient initialization pattern.

```go
type MailAdminClient struct {
    client *Client
    zoid   string // Cached organization ID (string for URL)
}
```

1. `NewMailAdminClient(cfg, tokenSource) (*MailAdminClient, error)`:
   - Create Client via NewClient
   - Fetch organization ID via GET `/api/organization/` (same as AdminClient but through DoMail)
   - Cache as string for URL construction
   - NOTE: If the organization endpoint is on APIBase (not MailBase), use client.Do instead. Test both -- AdminClient uses client.Do (APIBase). For mail admin endpoints that use org-level paths like `/api/organization/{zoid}/...`, the base URL may be MailBase. Check by looking at admin_client.go's getOrganizationID which uses client.Do (APIBase). For spam/retention which are at `/api/organization/{zoid}/antispam/...`, use DoMail (MailBase) per research patterns.
   - Alternative simpler approach: Reuse the existing AdminClient's zoid by accepting it as parameter, or create a lightweight wrapper that just needs the org ID.

   SIMPLIFICATION: Instead of a separate client, add methods directly to MailClient and accept zoid as parameter. The CLI command can use newAdminClient (already exists in admin_users.go) to get the zoid, then pass it to MailClient methods. This avoids duplicating the org ID resolution.

   Actually, best approach: Create a standalone `MailAdminClient` that wraps `*Client` and fetches its own zoid. The org endpoint (`/api/organization/`) uses APIBase (client.Do), not MailBase. Follow the exact pattern from AdminClient.getOrganizationID but store zoid as string.

2. `GetSpamSettings(ctx, category SpamCategory) ([]string, error)`:
   - GET `/api/organization/{zoid}/antispam/data?spamCategory={category}` via client.DoMail
   - Parse response, return list of values for that category
   - NOTE: Research is MEDIUM confidence on whether GET exists. If GET doesn't work, document limitation and skip this method. The update method (PUT) is well-documented.

3. `UpdateSpamList(ctx, category SpamCategory, values []string) error`:
   - Build SpamUpdateRequest with spamCategory and Value fields
   - PUT `/api/organization/{zoid}/antispam/data` via client.DoMail
   - Parse response, check status code

4. `GetRetentionPolicy(ctx) (json.RawMessage, error)`:
   - GET `/api/organization/{zoid}/mailpolicy/retention` via client.DoMail
   - Return raw JSON since retention policy structure is not well-documented
   - Let the CLI command handle display formatting

5. `GetDeliveryLogs(ctx, start, limit int) ([]DeliveryLog, error)`:
   - GET `/api/organization/{zoid}/deliverylog?start={start}&limit={limit}` via client.DoMail
   - Parse DeliveryLogListResponse, return Data
   - NOTE: Research says parameters are sparse. Include basic pagination.

Use map[string]SpamCategory for CLI-friendly name mapping:
```go
var SpamCategoryMap = map[string]SpamCategory{
    "allowlist-email":     WhiteListEmail,
    "blocklist-email":     SpamEmail,
    "reject-email":        RejectEmail,
    "quarantine-email":    QuarantineEmail,
    "trusted-email":       TrustedEmail,
    "allowlist-domain":    WhiteListDomain,
    "blocklist-domain":    SpamDomain,
    "reject-domain":       RejectDomain,
    "quarantine-domain":   QuarantineDomain,
    "trusted-domain":      TrustedDomain,
    "blocklist-tld":       SpamTLD,
    "reject-tld":          RejectTLD,
    "quarantine-tld":      QuarantineTLD,
    "allowlist-ip":        WhiteListIP,
    "blocklist-ip":        SpamIP,
    "reject-ip":           RejectIP,
    "quarantine-ip":       QuarantineIP,
}
```

Error handling: All methods use standard parseErrorResponse pattern. For methods where API behavior is uncertain (GetSpamSettings, GetRetentionPolicy), return clear error messages.
  </action>
  <verify>
`go build ./...` compiles successfully.
`go vet ./...` shows no warnings.
Grep for MailAdminClient, UpdateSpamList, GetDeliveryLogs in mail_admin.go confirms methods exist.
Grep for SpamCategory, DeliveryLog in mail_types.go confirms types exist.
  </verify>
  <done>
MailAdminClient wraps Client with cached organization ID.
Spam list update uses enum-based category system with user-friendly name mapping.
Retention policy and delivery log retrieval methods exist.
All admin types defined in mail_types.go.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mail admin CLI commands (retention, spam, delivery logs)</name>
  <files>internal/cli/mail_admin.go, internal/cli/cli.go</files>
  <action>
Create `internal/cli/mail_admin.go` with admin commands:

**Helper: newMailAdminClient(cfg) (*zoho.MailAdminClient, error):**
- Same pattern as newMailClient and newAdminClient: secrets store -> token cache -> MailAdminClient
- Handle auth errors with CLIError ExitAuth

**Retention command:**

`MailAdminRetentionGetCmd`:
- No args/flags
- Run: newMailAdminClient, mac.GetRetentionPolicy. If returns raw JSON, use PrintDetail or print formatted JSON. If error indicates endpoint doesn't exist, print "Retention policy API not available -- use Zoho Admin Console" to os.Stderr.

**Spam commands:**

`MailAdminSpamGetCmd`:
- `--category` flag (required string), validate against SpamCategoryMap keys
- Run: newMailAdminClient, resolve category via SpamCategoryMap, mac.GetSpamSettings. PrintList with Value column. If GET not supported, print informational message.

`MailAdminSpamUpdateCmd`:
- `--category` flag (required string), `--values` flag (required []string, repeatable, "email addresses, domains, or IPs to add")
- Run: Validate category. newMailAdminClient, resolve category, mac.UpdateSpamList. Print "Updated {category} with {N} entries" to os.Stderr.
- List valid categories in help text.

`MailAdminSpamCategoriesCmd`:
- No args/flags
- Run: Print all available spam category names from SpamCategoryMap. Use PrintList with Name and API Value columns. This helps users discover valid category names.

**Delivery logs command:**

`MailAdminLogsCmd`:
- `--limit` flag (int, default 50), `--start` flag (int, default 0)
- Run: newMailAdminClient, mac.GetDeliveryLogs. PrintList with columns: Subject, From, To, Status, SentTime, DeliveryTime. If error, print informational message about API limitations.

**Display struct:**
- `DeliveryLogRow`: Same fields as DeliveryLog but with formatted timestamps if needed.

**Update cli.go:**
- Add `MailAdmin MailAdminCmd` field to `MailCmd` struct (name:"admin")
- Create `MailAdminCmd` struct with: `Retention MailAdminRetentionCmd`, `Spam MailAdminSpamCmd`, `Logs MailAdminLogsCmd`
- `MailAdminRetentionCmd`: Get
- `MailAdminSpamCmd`: Get + Update + Categories
- `MailAdminLogsCmd` is directly a Run command (no subcommands)

Command hierarchy:
- `zoh mail admin retention get`
- `zoh mail admin spam get --category allowlist-email`
- `zoh mail admin spam update --category blocklist-domain --values spam.com --values junk.org`
- `zoh mail admin spam categories`
- `zoh mail admin logs [--limit 50] [--start 0]`

Follow existing CLI patterns:
- output.CLIError for errors
- os.Stderr for confirmations and informational messages
- Display structs for formatted output
- Graceful degradation for uncertain API endpoints (informational message instead of crash)
  </action>
  <verify>
`go build ./...` compiles successfully.
`go vet ./...` shows no warnings.
`./zoh mail admin --help` shows retention, spam, logs subcommands.
`./zoh mail admin retention get --help` shows command.
`./zoh mail admin spam update --help` shows --category and --values flags.
`./zoh mail admin spam categories --help` shows command.
`./zoh mail admin logs --help` shows --limit and --start flags.
  </verify>
  <done>
Users can view retention policies, manage spam allowlists/blocklists by category, list spam categories, and view delivery logs.
All admin commands registered in command tree under `zoh mail admin`.
Spam categories use user-friendly names mapped to Zoho API enum values.
Graceful degradation for poorly-documented API endpoints.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` -- entire project compiles
2. `go vet ./...` -- no warnings
3. `./zoh mail admin --help` -- shows retention, spam, logs subcommands
4. `./zoh mail admin retention get --help` -- shows command
5. `./zoh mail admin spam get --help` -- shows --category flag
6. `./zoh mail admin spam update --help` -- shows --category and --values flags
7. `./zoh mail admin spam categories --help` -- shows command
8. `./zoh mail admin logs --help` -- shows --limit and --start flags
</verification>

<success_criteria>
- MailAdminClient with cached organization ID for org-level operations
- Spam control with enum-based categories and user-friendly CLI names
- Retention policy viewing (read-only, graceful degradation if API unavailable)
- Delivery log viewing with pagination
- All admin commands registered under `zoh mail admin` with correct help
- SpamCategoryMap provides discoverable mapping from CLI names to API enums
</success_criteria>

<output>
After completion, create `.planning/phases/05-mail-send-settings-admin/05-03-SUMMARY.md`
</output>
