---
phase: 06-cli-polish-power-user-ux
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - main.go
  - go.mod
  - go.sum
  - internal/cli/cli.go
  - internal/cli/completion.go
autonomous: true

must_haves:
  truths:
    - "User can run 'zoh completion install bash' to install bash completions"
    - "User can run 'zoh completion install zsh' to install zsh completions"
    - "User can run 'zoh completion install fish' to install fish completions"
    - "Tab completion suggests subcommands after 'zoh ' in configured shells"
    - "Tab completion suggests flags after 'zoh admin users list --'"
    - "File path completion works for attachment arguments"
  artifacts:
    - path: "main.go"
      provides: "kongplete.Complete() call before parser.Parse()"
      contains: "kongplete"
    - path: "internal/cli/cli.go"
      provides: "Completion install command in CLI struct"
      contains: "InstallCompletions"
    - path: "internal/cli/completion.go"
      provides: "Completion command wrapper and custom predictors"
      contains: "predictor"
    - path: "go.mod"
      provides: "kongplete and posener/complete dependencies"
      contains: "kongplete"
  key_links:
    - from: "main.go"
      to: "kongplete"
      via: "Complete() call intercepts completion requests before normal parsing"
      pattern: "kongplete\\.Complete"
    - from: "internal/cli/cli.go"
      to: "internal/cli/completion.go"
      via: "CLI struct includes completion install command"
      pattern: "CompletionCmd"
---

<objective>
Add shell completion support for bash, zsh, and fish using kongplete library, with custom file predictors for attachment arguments.

Purpose: Shell completion makes zoh discoverable and fast for power users who rely on tab-completion for command exploration and argument filling.
Output: kongplete integration in main.go, completion install command, custom predictors.
</objective>

<execution_context>
@/home/semmy/.claude/get-shit-done/workflows/execute-plan.md
@/home/semmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cli-polish-power-user-ux/06-RESEARCH.md
@.planning/phases/06-cli-polish-power-user-ux/06-01-SUMMARY.md
@main.go
@internal/cli/cli.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add kongplete dependency and wire shell completion into CLI</name>
  <files>go.mod, go.sum, main.go, internal/cli/cli.go, internal/cli/completion.go</files>
  <action>
1. Add dependencies:
   ```bash
   cd /home/semmy/codeprojects/zohod-cli
   go get github.com/willabides/kongplete@latest
   go get github.com/posener/complete@latest
   ```

2. Create `internal/cli/completion.go`:
   ```go
   package cli

   import "github.com/willabides/kongplete"

   // CompletionCmd wraps kongplete's InstallCompletions
   type CompletionCmd struct {
       Install kongplete.InstallCompletions `cmd:"" help:"Install shell completions for bash, zsh, or fish"`
   }
   ```

3. In `internal/cli/cli.go`, add to CLI struct:
   ```go
   // Shell completion
   Completion CompletionCmd `cmd:"" help:"Shell completion commands"`
   ```

4. In `main.go`, restructure to use `kong.Must()` instead of `kong.Parse()` so we can call `kongplete.Complete()` between parser creation and parsing:
   ```go
   import (
       "github.com/willabides/kongplete"
       "github.com/posener/complete"
   )

   func main() {
       cliInstance := &cli.CLI{}

       parser := kong.Must(cliInstance,
           kong.Name("zoh"),
           kong.Description("Zoho CLI for Admin and Mail operations"),
           kong.UsageOnError(),
           kong.ConfigureHelp(kong.HelpOptions{
               Compact: true,
           }),
           kong.Vars{
               "version": version,
           },
       )

       // Wire shell completion — intercepts tab-completion requests before normal parsing
       kongplete.Complete(parser,
           kongplete.WithPredictor("file", complete.PredictFiles("*")),
       )

       // Parse and run
       ctx, err := parser.Parse(os.Args[1:])
       parser.FatalIfErrorf(err)

       err = ctx.Run()
       if err != nil {
           // ... existing error handling ...
       }
   }
   ```

   Note: The key change is splitting `kong.Parse()` into `kong.Must()` + `parser.Parse()` with `kongplete.Complete()` in between. This is required because kongplete needs to intercept the completion request before args are parsed.

5. Add `predictor:"file"` tag to attachment-related command fields. Check these structs:
   - `MailSendComposeCmd` — find the attachment file path field and add `predictor:"file"`
   - `MailSendReplyCmd` — find attachment field, add `predictor:"file"`
   - `MailSendForwardCmd` — find attachment field, add `predictor:"file"`
   - `MailAttachmentsDownloadCmd` — find output path field, add `predictor:"file"`
  </action>
  <verify>
Run `go build ./...` — compiles with new kongplete dependency. Run `go vet ./...` — passes. Run `go run . completion install --help` — shows installation instructions for bash/zsh/fish.
  </verify>
  <done>
kongplete is wired into main.go with Complete() call before Parse(). Completion install command is available at `zoh completion install`. File predictor is attached to attachment path arguments. Project builds successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify build and completion script generation</name>
  <files>main.go</files>
  <action>
1. Run full build verification:
   ```bash
   cd /home/semmy/codeprojects/zohod-cli
   go build -o /tmp/zoh ./
   go vet ./...
   ```

2. Verify `zoh completion install --help` shows the three shells (bash, zsh, fish).

3. Verify the binary runs correctly for normal commands:
   ```bash
   /tmp/zoh --help
   /tmp/zoh schema | head -5
   /tmp/zoh ls --help
   /tmp/zoh send --help
   /tmp/zoh --dry-run --help
   ```

4. Verify flag conflict validation:
   ```bash
   /tmp/zoh --force --dry-run version 2>&1  # Should error
   /tmp/zoh --results-only version 2>&1      # Should error (not json mode)
   ```

5. If any compilation errors or issues found, fix them. Common issues:
   - Import path conflicts — ensure kongplete and complete imports resolve correctly
   - Kong parser changes — kong.Must() vs kong.Parse() signature differences
   - Missing `os` import in main.go after restructure

6. Clean up: `rm /tmp/zoh`
  </action>
  <verify>
`go build ./...` succeeds. `go vet ./...` passes. Binary runs all commands correctly. Completion install help shows bash/zsh/fish options.
  </verify>
  <done>
Full build succeeds. All commands work: help, schema, shortcuts (send, ls), completion install. Flag validation works for conflicting combinations. Shell completion is ready for user installation.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. `go vet ./...` passes
3. `zoh completion install --help` shows bash, zsh, fish options
4. `zoh --help` shows all commands (shortcuts hidden)
5. `zoh schema` outputs valid JSON
6. Normal command execution still works end-to-end
</verification>

<success_criteria>
- kongplete and posener/complete added as dependencies
- Shell completion install command available at `zoh completion install`
- File predictor wired to attachment path arguments
- Build succeeds, vet passes, all existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-polish-power-user-ux/06-03-SUMMARY.md`
</output>
