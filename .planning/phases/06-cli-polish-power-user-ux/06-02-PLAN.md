---
phase: 06-cli-polish-power-user-ux
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - internal/cli/admin_users.go
  - internal/cli/admin_groups.go
  - internal/cli/admin_domains.go
  - internal/cli/mail_send.go
  - internal/cli/mail_settings.go
  - internal/cli/mail_admin.go
autonomous: true

must_haves:
  truths:
    - "User can run any admin create/update/delete command with --dry-run and see what would happen without API calls"
    - "User can run mail send compose/reply/forward with --dry-run and see the email that would be sent"
    - "User can run mail settings update commands with --dry-run and see the changes that would be made"
    - "User can run admin commands with --force to skip the --confirm requirement on delete operations"
    - "Dry-run output goes to stderr with [DRY RUN] prefix so stdout stays clean for piping"
    - "Read-only commands (list, get, search) silently ignore --dry-run"
  artifacts:
    - path: "internal/cli/admin_users.go"
      provides: "Dry-run checks on create, update, activate, deactivate, delete commands; --force bypasses --confirm on delete"
      contains: "DRY RUN"
    - path: "internal/cli/admin_groups.go"
      provides: "Dry-run checks on create, update, delete, member add/remove commands; --force bypasses --confirm on delete"
      contains: "DRY RUN"
    - path: "internal/cli/admin_domains.go"
      provides: "Dry-run checks on add, verify, update commands"
      contains: "DRY RUN"
    - path: "internal/cli/mail_send.go"
      provides: "Dry-run checks on compose, reply, forward commands"
      contains: "DRY RUN"
    - path: "internal/cli/mail_settings.go"
      provides: "Dry-run checks on signature create, vacation set/disable, display name set"
      contains: "DRY RUN"
    - path: "internal/cli/mail_admin.go"
      provides: "Dry-run check on spam update command"
      contains: "DRY RUN"
  key_links:
    - from: "internal/cli/admin_users.go"
      to: "internal/cli/globals.go"
      via: "Globals.DryRun and Globals.Force checked in Run methods"
      pattern: "globals\\.DryRun"
    - from: "internal/cli/admin_groups.go"
      to: "internal/cli/globals.go"
      via: "Globals.DryRun and Globals.Force checked in Run methods"
      pattern: "globals\\.DryRun"
---

<objective>
Add --dry-run preview and --force confirmation bypass to all mutating CLI commands across admin and mail operations.

Purpose: Power users can preview destructive operations before executing, and skip confirmation prompts in scripted workflows.
Output: Updated admin and mail command files with dry-run preview output and force bypass logic.
</objective>

<execution_context>
@/home/semmy/.claude/get-shit-done/workflows/execute-plan.md
@/home/semmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-cli-polish-power-user-ux/06-RESEARCH.md
@.planning/phases/06-cli-polish-power-user-ux/06-01-SUMMARY.md
@internal/cli/admin_users.go
@internal/cli/admin_groups.go
@internal/cli/admin_domains.go
@internal/cli/mail_send.go
@internal/cli/mail_settings.go
@internal/cli/mail_admin.go
@internal/cli/globals.go
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dry-run and force to admin mutating commands</name>
  <files>internal/cli/admin_users.go, internal/cli/admin_groups.go, internal/cli/admin_domains.go</files>
  <action>
The pattern for dry-run in each mutating command's `Run()` method is:

```go
// After parameter validation but BEFORE any API call:
if globals.DryRun {
    fmt.Fprintf(os.Stderr, "[DRY RUN] Would <action>: <details>\n")
    return nil
}
```

All dry-run output goes to stderr with `[DRY RUN]` prefix. Return nil immediately (no API call made).

**For --force on delete commands:** Currently `AdminUsersDeleteCmd` and `AdminGroupsDeleteCmd` have `Confirm bool` with `required:""` tag. The --force flag should bypass the confirm requirement. Change the approach:
- Remove `required:""` from the Confirm field tag (make it optional)
- Add check at start of Run: `if !cmd.Confirm && !globals.Force { return fmt.Errorf("deletion requires --confirm or --force flag") }`
- This lets --force bypass --confirm while keeping the safety net

**Commands needing `*Globals` parameter added to Run()** (check which don't already have it):
- AdminUsersCreateCmd, AdminUsersUpdateCmd, AdminUsersActivateCmd, AdminUsersDeactivateCmd, AdminUsersDeleteCmd already receive `globals *Globals`
- AdminGroupsListCmd, AdminGroupsGetCmd, AdminGroupsCreateCmd, AdminGroupsUpdateCmd, AdminGroupsDeleteCmd, AdminGroupsMembersAddCmd, AdminGroupsMembersRemoveCmd — check signatures, add `globals *Globals` parameter to those missing it
- AdminDomainsListCmd, AdminDomainsGetCmd, AdminDomainsAddCmd, AdminDomainsVerifyCmd, AdminDomainsUpdateCmd — add `globals *Globals` to mutating commands that don't have it

**admin_users.go mutations:**
1. `AdminUsersCreateCmd.Run()` — dry-run: "Would create user: {email} (firstName={FirstName}, lastName={LastName})"
2. `AdminUsersUpdateCmd.Run()` — dry-run: "Would update user {identifier}: role={Role}"
3. `AdminUsersActivateCmd.Run()` — dry-run: "Would activate user: {identifier}"
4. `AdminUsersDeactivateCmd.Run()` — dry-run: "Would deactivate user: {identifier}"
5. `AdminUsersDeleteCmd.Run()` — dry-run: "Would permanently delete user: {identifier}". Also add --force bypass for --confirm.

**admin_groups.go mutations:**
1. `AdminGroupsCreateCmd.Run()` — add `globals *Globals` param. Dry-run: "Would create group: {name} (email={EmailId})"
2. `AdminGroupsUpdateCmd.Run()` — add `globals *Globals` param. Dry-run: "Would update group {groupId}: name={Name}"
3. `AdminGroupsDeleteCmd.Run()` — add `globals *Globals` param. Dry-run: "Would permanently delete group: {groupId}". Also add --force bypass for --confirm.
4. `AdminGroupsMembersAddCmd.Run()` — add `globals *Globals` param. Dry-run: "Would add {N} member(s) to group {groupId}"
5. `AdminGroupsMembersRemoveCmd.Run()` — add `globals *Globals` param. Dry-run: "Would remove {N} member(s) from group {groupId}"

**admin_domains.go mutations:**
1. `AdminDomainsAddCmd.Run()` — add `globals *Globals` param. Dry-run: "Would add domain: {DomainName}"
2. `AdminDomainsVerifyCmd.Run()` — add `globals *Globals` param. Dry-run: "Would verify domain {DomainName} using method={Method}"
3. `AdminDomainsUpdateCmd.Run()` — add `globals *Globals` param. Dry-run: "Would update domain {DomainName}: mode={Mode}"
  </action>
  <verify>
Run `go build ./...` — compiles. Run `go vet ./...` — passes.
  </verify>
  <done>
All admin mutating commands check globals.DryRun and print preview to stderr without making API calls. Delete commands accept --force as alternative to --confirm. Commands that previously lacked globals parameter now receive it.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dry-run to mail mutating commands</name>
  <files>internal/cli/mail_send.go, internal/cli/mail_settings.go, internal/cli/mail_admin.go</files>
  <action>
Same dry-run pattern: check `globals.DryRun` after parameter validation, before API calls. Print preview to stderr with `[DRY RUN]` prefix, return nil.

**Commands needing `globals *Globals` parameter added:** Check current signatures and add where missing. Most mail send/settings commands may not have it yet.

**mail_send.go mutations:**
1. `MailSendComposeCmd.Run()` — add `globals *Globals` param. Dry-run: print email preview:
   ```
   [DRY RUN] Would send email:
     To: {To}
     Cc: {Cc}
     Bcc: {Bcc}
     Subject: {Subject}
     Attachments: {len(Attachments)} file(s)
   ```
2. `MailSendReplyCmd.Run()` — add `globals *Globals` param. Dry-run: "Would reply to message {MessageId} (reply-all={ReplyAll})"
3. `MailSendForwardCmd.Run()` — add `globals *Globals` param. Dry-run: "Would forward message {MessageId} to {To}"

**mail_settings.go mutations:**
1. `MailSettingsSignaturesCreateCmd.Run()` — add `globals *Globals` param (currently takes only `cfg *config.Config`). Dry-run: "Would create signature: name={Name}"
2. `MailSettingsVacationSetCmd.Run()` — add `globals *Globals` param. Dry-run: "Would enable vacation reply: subject={Subject}"
3. `MailSettingsVacationDisableCmd.Run()` — add `globals *Globals` param. Dry-run: "Would disable vacation auto-reply"
4. `MailSettingsDisplayNameSetCmd.Run()` — add `globals *Globals` param. Dry-run: "Would update display name to: {Name}"

**mail_admin.go mutations:**
1. `MailAdminSpamUpdateCmd.Run()` — add `globals *Globals` param (currently takes only `cfg *config.Config`). Dry-run: "Would update {Category} {ListType}: {Action} {len(Addresses)} address(es)"
  </action>
  <verify>
Run `go build ./...` — compiles. Run `go vet ./...` — passes.
  </verify>
  <done>
All mail mutating commands check globals.DryRun and print preview to stderr without making API calls. Every mutating command in the entire CLI now supports --dry-run.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` compiles without errors
2. `go vet ./...` passes
3. Every mutating command has dry-run check (grep for `globals.DryRun` in all command files)
4. Delete commands accept --force as alternative to --confirm
5. No read-only command (list, get, search) has dry-run logic (they silently ignore it)
</verification>

<success_criteria>
- All 18+ mutating commands check globals.DryRun before API calls
- Dry-run output goes to stderr with [DRY RUN] prefix
- Delete commands accept --force OR --confirm
- Read-only commands ignore --dry-run silently
- Project compiles and passes vet
</success_criteria>

<output>
After completion, create `.planning/phases/06-cli-polish-power-user-ux/06-02-SUMMARY.md`
</output>
