---
phase: 03-admin-domains-audit
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/zoho/types.go
  - internal/zoho/admin_client.go
  - internal/zoho/timeutil.go
  - internal/cli/admin_audit.go
  - internal/cli/cli.go
autonomous: true

must_haves:
  truths:
    - "User can view admin action audit logs filtered by date range"
    - "User can view login history logs filtered by date range with mode selection"
    - "User can view SMTP transaction logs filtered by date range"
    - "User sees informative message when requesting active sessions or security policies (if no API available)"
  artifacts:
    - path: "internal/zoho/types.go"
      provides: "AuditLog, LoginHistoryEntry, SMTPLogEntry and their response types"
      contains: "type AuditLog struct"
    - path: "internal/zoho/admin_client.go"
      provides: "GetAuditLogs, GetLoginHistory, GetSMTPLogs methods with cursor pagination"
      contains: "func (ac *AdminClient) GetAuditLogs"
    - path: "internal/zoho/timeutil.go"
      provides: "ToUnixMillis, FromUnixMillis, FormatMillisTimestamp helpers"
      contains: "func ToUnixMillis"
    - path: "internal/cli/admin_audit.go"
      provides: "Audit CLI commands: logs, login-history, smtp-logs, sessions, security"
      contains: "AdminAuditLogsCmd"
    - path: "internal/cli/cli.go"
      provides: "AdminAuditCmd registration in AdminCmd"
      contains: "Audit AdminAuditCmd"
  key_links:
    - from: "internal/cli/admin_audit.go"
      to: "internal/zoho/admin_client.go"
      via: "newAdminClient helper → AdminClient audit methods"
      pattern: "ac\\.GetAuditLogs|ac\\.GetLoginHistory|ac\\.GetSMTPLogs"
    - from: "internal/zoho/admin_client.go"
      to: "internal/zoho/timeutil.go"
      via: "Time conversion for millisecond timestamps"
      pattern: "ToUnixMillis|FromUnixMillis"
    - from: "internal/cli/admin_audit.go"
      to: "internal/zoho/timeutil.go"
      via: "Timestamp formatting for display"
      pattern: "FormatMillisTimestamp"
---

<objective>
Implement audit and security log CLI commands: admin action logs, login history, SMTP logs, and informational fallbacks for active sessions and security policies.

Purpose: Complete the audit and security requirements (ADMIN-AUD-01 through ADMIN-AUD-04) so users can access audit data and security information from the terminal. For operations where documented API endpoints don't exist (active sessions, security policies), provide clear informational messages directing users to the web console.

Output: Working `zoh admin audit logs|login-history|smtp-logs|sessions|security` commands with cursor-based pagination, date range filtering, and all three output modes.
</objective>

<execution_context>
@/home/semmy/.claude/get-shit-done/workflows/execute-plan.md
@/home/semmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-domains-audit/03-RESEARCH.md
@.planning/phases/02-admin-users-groups/02-01-SUMMARY.md

Key codebase references:
@internal/zoho/admin_client.go  — Existing AdminClient (extend with audit methods)
@internal/zoho/types.go         — Existing types (append audit types)
@internal/zoho/pagination.go    — Existing PageIterator (audit APIs use cursor pagination, NOT offset pagination — implement inline cursor loops, not PageIterator)
@internal/cli/admin_groups.go   — Reference for CLI command patterns
@internal/cli/cli.go            — Command registration
</context>

<tasks>

<task type="auto">
  <name>Task 1: Audit types, time helpers, and AdminClient audit methods</name>
  <files>internal/zoho/types.go, internal/zoho/timeutil.go, internal/zoho/admin_client.go</files>
  <action>
**Create internal/zoho/timeutil.go** — Time conversion utilities:

```go
package zoho

import "time"

// ToUnixMillis converts time.Time to Unix milliseconds (int64)
func ToUnixMillis(t time.Time) int64 {
    return t.UnixMilli()
}

// FromUnixMillis converts Unix milliseconds (int64) to time.Time
func FromUnixMillis(ms int64) time.Time {
    return time.UnixMilli(ms)
}

// FormatMillisTimestamp formats a millisecond timestamp for display in RFC3339
func FormatMillisTimestamp(ms int64) string {
    if ms == 0 {
        return ""
    }
    return FromUnixMillis(ms).Format(time.RFC3339)
}
```

**In internal/zoho/types.go**, append audit/log types after the domain types (or after existing types if domain types aren't there yet — this plan runs in parallel with 03-01):

1. `AuditLog` struct:
   - `SubCategory string` (json:"subCategory")
   - `Data map[string]interface{}` (json:"data")
   - `Type string` (json:"type")
   - `RequestTime int64` (json:"requestTime") — Unix milliseconds
   - `PerformedBy string` (json:"performedBy")
   - `AuditLogType string` (json:"auditLogType")
   - `ClientIP string` (json:"clientIp")
   - `MainCategory string` (json:"mainCategory")
   - `OperationType string` (json:"operationType")
   - `PerformedOn string` (json:"performedOn")
   - `Category string` (json:"category")
   - `Operation string` (json:"operation")

2. `AuditLogResponse` — nested Status (Code int, Description string) + Data struct with:
   - `Audit []AuditLog` (json:"audit")
   - `LastIndexTime string` (json:"lastIndexTime")
   - `LastEntityID string` (json:"lastEntityId")

3. `LoginHistoryEntry` struct:
   - `UserID int64` (json:"userId")
   - `EmailAddress string` (json:"emailAddress")
   - `IPAddress string` (json:"ipAddress")
   - `LoginTime int64` (json:"loginTime") — Unix milliseconds
   - `Status string` (json:"status")
   - `AccessType string` (json:"accessType")
   - `ClientInfo string` (json:"clientInfo")

4. `LoginHistoryResponse` — nested Status + Data struct with:
   - `LoginHistory []LoginHistoryEntry` (json:"loginHistory")
   - `ScrollID string` (json:"scrollId")

5. `SMTPLogEntry` struct:
   - `MessageID string` (json:"messageId")
   - `FromAddress string` (json:"fromAddr")
   - `ToAddresses []string` (json:"toAddr")
   - `Subject string` (json:"subject")
   - `TransactionID string` (json:"transactionId")
   - `Timestamp int64` (json:"timestamp") — Unix milliseconds
   - `Status string` (json:"status")

6. `SMTPLogResponse` — nested Status + Data struct with:
   - `HasNext bool` (json:"hnxt")
   - `HasPrevious bool` (json:"hasPrevious")
   - `PageKey string` (json:"pagekey")
   - `PagePrevKey string` (json:"pagePrevKey")
   - `Response []SMTPLogEntry` (json:"response")

**In internal/zoho/admin_client.go**, add these methods:

1. `GetAuditLogs(ctx context.Context, startTime, endTime time.Time, searchKey string, limit int) ([]AuditLog, error)`:
   - Convert times to milliseconds via `startTime.UnixMilli()`, `endTime.UnixMilli()`
   - Build path: `/api/organization/{zoid}/activity?startTime={ms}&endTime={ms}&limit={limit}`
   - If searchKey != "", add `&searchKey={url.QueryEscape(searchKey)}`
   - Implement cursor pagination loop:
     - Track lastEntityID and lastIndexTime (both strings)
     - After first request, if response has LastEntityID and len(Audit) > 0, append `&lastEntityId={id}&lastIndexTime={time}` to next request
     - Break when LastEntityID == "" or len(Audit) == 0
   - If limit <= 0, default to 100 per page
   - Add `"net/url"` import for url.QueryEscape
   - Add `"time"` import

2. `GetLoginHistory(ctx context.Context, mode string, startTime, endTime time.Time, batchSize int) ([]LoginHistoryEntry, error)`:
   - Validate 90-day limit: if startTime is before `time.Now().AddDate(0, 0, -90)`, return error "login history only available for last 90 days"
   - Build path: `/api/organization/{zoid}/accounts/reports/loginHistory?mode={mode}&fromTime={ms}&toTime={ms}&batchSize={batchSize}`
   - Implement scrollId cursor loop:
     - Track scrollID string
     - After first request, if response has ScrollID and len(LoginHistory) > 0, append `&scrollId={id}`
     - Break when ScrollID == "" or len(LoginHistory) == 0
   - If batchSize <= 0, default to 100
   - Valid modes: "loginActivity", "failedLoginActivity", "protocolLoginActivity", "failedProtocolLoginActivity"

3. `GetSMTPLogs(ctx context.Context, startTime, endTime time.Time, searchCriteria, searchKey string, limit int) ([]SMTPLogEntry, error)`:
   - This is a POST endpoint (unlike the others which are GET)
   - Path: `/api/organization/{zoid}/smtplogs`
   - Build request body as map[string]interface{}:
     ```
     {
       "fromDateTime": startMillis,
       "toDateTime": endMillis,
       "searchCriteria": searchCriteria, // "messageId", "fromAddr", "toAddr", or ""
       "searchKey": searchKey,
       "limit": limit,
       "isNext": false,
       "isPrevious": false,
       "pageKey": "",
       "prevKey": ""
     }
     ```
   - Implement forward pagination loop:
     - After first request, if response HasNext and len(Response) > 0, set isNext=true and pageKey=response.PageKey
     - Break when !HasNext or len(Response) == 0
   - If limit <= 0, default to 100
  </action>
  <verify>
Run `go build ./internal/zoho/...` and `go vet ./internal/zoho/...` — both must pass with zero errors or warnings.
  </verify>
  <done>
Audit types defined in types.go. Time helpers in timeutil.go. Three AdminClient methods (GetAuditLogs, GetLoginHistory, GetSMTPLogs) with cursor-based pagination compile and follow established patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Audit CLI commands and registration</name>
  <files>internal/cli/admin_audit.go, internal/cli/cli.go</files>
  <action>
**Create internal/cli/admin_audit.go** following the exact patterns from admin_groups.go and admin_users.go:

Import the zoho package for `FormatMillisTimestamp` (use `zoho.FormatMillisTimestamp`).

1. **AdminAuditLogsCmd** — Admin action audit logs (ADMIN-AUD-01 & AUD-02):
   - Flags:
     - `From string` (required, help:"Start date (YYYY-MM-DD or RFC3339)") — parsed via `time.Parse`
     - `To string` (required, help:"End date (YYYY-MM-DD or RFC3339)") — parsed via `time.Parse`
     - `Search string` (optional, help:"Filter by category, performer, or operation")
     - `Limit int` (default:100, help:"Results per page")
   - Parse dates: try RFC3339 first (`time.RFC3339`), then date-only (`"2006-01-02"`, set time to start/end of day). For `--from` date-only: set to 00:00:00 UTC. For `--to` date-only: set to 23:59:59 UTC.
   - Call `ac.GetAuditLogs(ctx, fromTime, toTime, cmd.Search, cmd.Limit)`
   - Print list with columns: Time (use `zoho.FormatMillisTimestamp(log.RequestTime)`), Category, Operation, Performed By, Target (PerformedOn), IP
   - Use fp.Formatter.PrintList()

2. **AdminAuditLoginHistoryCmd** — Login history logs (ADMIN-AUD-01):
   - Flags:
     - `From string` (required, help:"Start date (YYYY-MM-DD or RFC3339)")
     - `To string` (required, help:"End date (YYYY-MM-DD or RFC3339)")
     - `Mode string` (default:"loginActivity", enum:"loginActivity,failedLoginActivity,protocolLoginActivity,failedProtocolLoginActivity", help:"Activity type filter")
     - `Limit int` (default:100, help:"Batch size per page")
   - Parse dates same as AuditLogsCmd
   - Call `ac.GetLoginHistory(ctx, cmd.Mode, fromTime, toTime, cmd.Limit)`
   - Print list with columns: Time (FormatMillisTimestamp), Email, IP, Status, Access Type, Client
   - Include help text noting 90-day retention limit

3. **AdminAuditSMTPLogsCmd** — SMTP transaction logs (ADMIN-AUD-02):
   - Flags:
     - `From string` (required, help:"Start date (YYYY-MM-DD or RFC3339)")
     - `To string` (required, help:"End date (YYYY-MM-DD or RFC3339)")
     - `SearchBy string` (optional, enum:"messageId,fromAddr,toAddr", help:"Search criteria field")
     - `Search string` (optional, help:"Search value (requires --search-by)")
     - `Limit int` (default:100, help:"Results per page")
   - Validate: if Search is set but SearchBy is not, return usage error
   - Call `ac.GetSMTPLogs(ctx, fromTime, toTime, cmd.SearchBy, cmd.Search, cmd.Limit)`
   - Print list with columns: Time (FormatMillisTimestamp), From, To (join with ", "), Subject, Status, Message ID

4. **AdminAuditSessionsCmd** — Active sessions (ADMIN-AUD-03):
   - No flags needed
   - Print informational message to stderr: "Active session listing is not available via the Zoho Mail API.\nView active sessions in the Zoho Admin Console:\n  https://mailadmin.zoho.com → Dashboard → Active Sessions"
   - Return nil (not an error)

5. **AdminAuditSecurityCmd** — Security policies (ADMIN-AUD-04):
   - No flags needed
   - Print informational message to stderr: "Security policy settings (2FA, password policies) are not available via the Zoho Mail API.\nManage security settings in the Zoho Admin Console:\n  https://mailadmin.zoho.com → Security & Compliance"
   - Return nil (not an error)

**Date parsing helper** — Create a private `parseDate(s string, endOfDay bool) (time.Time, error)` function at the top of the file:
- Try `time.Parse(time.RFC3339, s)` first
- If that fails, try `time.Parse("2006-01-02", s)` and set time to 00:00:00 UTC (or 23:59:59 UTC if endOfDay is true)
- If both fail, return descriptive error: "invalid date format: use YYYY-MM-DD or RFC3339"

**In internal/cli/cli.go**, add audit registration:

1. Add `Audit AdminAuditCmd` field to `AdminCmd` struct (alongside Users, Groups, and Domains).
2. Create `AdminAuditCmd` struct:
```go
type AdminAuditCmd struct {
    Logs         AdminAuditLogsCmd         `cmd:"" help:"View admin action audit logs"`
    LoginHistory AdminAuditLoginHistoryCmd `cmd:"login-history" help:"View login history (90-day retention)"`
    SMTPLogs     AdminAuditSMTPLogsCmd     `cmd:"smtp-logs" help:"View SMTP transaction logs"`
    Sessions     AdminAuditSessionsCmd     `cmd:"" help:"View active sessions"`
    Security     AdminAuditSecurityCmd     `cmd:"" help:"View security policy settings"`
}
```
  </action>
  <verify>
Run `go build ./...` and `go vet ./...` — full project must compile. Then verify CLI structure:
- `./zoh admin audit --help` should show logs, login-history, smtp-logs, sessions, security subcommands
- `./zoh admin audit logs --help` should show --from, --to, --search, --limit flags
- `./zoh admin audit login-history --help` should show --from, --to, --mode, --limit flags
- `./zoh admin audit smtp-logs --help` should show --from, --to, --search-by, --search, --limit flags
  </verify>
  <done>
Five audit CLI commands registered under `zoh admin audit`. Three functional commands (logs, login-history, smtp-logs) with date range filtering and cursor pagination. Two informational commands (sessions, security) with web console redirect messages. All output modes work.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` — Full project compiles with zero errors
2. `go vet ./...` — No warnings
3. `./zoh admin --help` — Shows "audit" alongside "users", "groups", and "domains"
4. `./zoh admin audit --help` — Shows all 5 subcommands
5. `./zoh admin audit logs --help` — Shows --from, --to required flags
6. `./zoh admin audit login-history --help` — Shows --mode enum and 90-day note
7. `./zoh admin audit smtp-logs --help` — Shows --search-by enum
8. `./zoh admin audit sessions` — Prints informational message (not an error)
9. `./zoh admin audit security` — Prints informational message (not an error)
</verification>

<success_criteria>
- All five audit subcommands (logs, login-history, smtp-logs, sessions, security) compile and are accessible via CLI
- Audit logs and login history use cursor-based pagination (not offset pagination)
- SMTP logs use POST with dual-cursor forward pagination
- Date range parsing supports both YYYY-MM-DD and RFC3339 formats
- Login history validates 90-day retention limit before making API request
- Sessions and security commands print helpful web console redirect messages (not errors)
- Time conversion helpers (timeutil.go) handle millisecond timestamps correctly
- All output modes (JSON, plain, rich) work for audit commands
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-domains-audit/03-02-SUMMARY.md`
</output>
