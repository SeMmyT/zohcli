---
phase: 03-admin-domains-audit
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - internal/zoho/types.go
  - internal/zoho/admin_client.go
  - internal/cli/admin_domains.go
  - internal/cli/cli.go
autonomous: true

must_haves:
  truths:
    - "User can list all domains in the organization with verification status"
    - "User can get detailed domain settings including DNS verification codes"
    - "User can add a new domain and see the required DNS records for verification"
    - "User can trigger domain verification via TXT, CNAME, or HTML method"
    - "User can update domain-level settings (DKIM, hosting, primary)"
  artifacts:
    - path: "internal/zoho/types.go"
      provides: "Domain, DomainListResponse, DomainDetailResponse, AddDomainRequest, VerifyDomainRequest types"
      contains: "type Domain struct"
    - path: "internal/zoho/admin_client.go"
      provides: "ListDomains, GetDomain, AddDomain, VerifyDomain, UpdateDomainSettings methods"
      contains: "func (ac *AdminClient) ListDomains"
    - path: "internal/cli/admin_domains.go"
      provides: "Domain CLI commands: list, get, add, verify, update"
      contains: "AdminDomainsListCmd"
    - path: "internal/cli/cli.go"
      provides: "AdminDomainsCmd registration in AdminCmd"
      contains: "Domains AdminDomainsCmd"
  key_links:
    - from: "internal/cli/admin_domains.go"
      to: "internal/zoho/admin_client.go"
      via: "newAdminClient helper → AdminClient domain methods"
      pattern: "ac\\.ListDomains|ac\\.GetDomain|ac\\.AddDomain|ac\\.VerifyDomain"
    - from: "internal/zoho/admin_client.go"
      to: "internal/zoho/types.go"
      via: "Domain type definitions"
      pattern: "DomainListResponse|DomainDetailResponse"
---

<objective>
Implement domain management CLI commands: list all domains, get domain details, add a new domain, verify domain ownership, and update domain settings.

Purpose: Complete the domain management requirements (ADMIN-DOM-01 through ADMIN-DOM-05) so users can manage domains entirely from the terminal without touching the Zoho web console.

Output: Working `zoh admin domains list|get|add|verify|update` commands with all three output modes (JSON, plain, rich).
</objective>

<execution_context>
@/home/semmy/.claude/get-shit-done/workflows/execute-plan.md
@/home/semmy/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-admin-domains-audit/03-RESEARCH.md
@.planning/phases/02-admin-users-groups/02-01-SUMMARY.md
@.planning/phases/02-admin-users-groups/02-03-SUMMARY.md

Key codebase references:
@internal/zoho/admin_client.go  — Existing AdminClient with user/group methods (follow same patterns)
@internal/zoho/types.go         — Existing type definitions (append domain types)
@internal/zoho/pagination.go    — Existing PageIterator (domain list does NOT need pagination — returns all in one response)
@internal/cli/admin_groups.go   — Reference for CLI command patterns (resolveGroupID, newAdminClient, output formatting)
@internal/cli/cli.go            — Command registration structure (add Domains alongside Users/Groups)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Domain types and AdminClient domain methods</name>
  <files>internal/zoho/types.go, internal/zoho/admin_client.go</files>
  <action>
**In internal/zoho/types.go**, append the following domain-related types after the existing group types:

1. `Domain` struct with fields from the API:
   - `DomainName string` (json:"domainName")
   - `DomainID string` (json:"domainId")
   - `VerificationStatus bool` (json:"verificationStatus")
   - `DKIMStatus bool` (json:"dkimstatus")
   - `SPFStatus bool` (json:"spfstatus")
   - `MXStatus string` (json:"mxstatus")
   - `VerifiedDate int64` (json:"verifiedDate") — Unix milliseconds
   - `MailHostingEnabled bool` (json:"mailHostingEnabled")
   - `IsDomainAlias bool` (json:"isDomainAlias")
   - `IsExpired bool` (json:"isExpired")
   - `Primary bool` (json:"primary")
   - `CNAMEVerificationCode string` (json:"CNAMEVerificationCode")
   - `HTMLVerificationCode string` (json:"HTMLVerificationCode")
   - `TXTVerificationCode string` (json:"txtRecord") — TXT record value for DNS verification

2. `DKIM` struct with:
   - `Selector string` (json:"selector")
   - `DomainName string` (json:"domainName")
   - `TXTRecord string` (json:"txtRecord")
   - `Status bool` (json:"status")

3. `DomainListResponse` — Status + Data []Domain (same pattern as UserListResponse)
4. `DomainDetailResponse` — Status + Data Domain (same pattern as UserDetailResponse)
5. `AddDomainRequest` — `DomainName string` (json:"domainName")
6. `DomainModeRequest` — `Mode string` (json:"mode") — used for verify, enable hosting, set primary, etc.

**In internal/zoho/admin_client.go**, add these methods (follow existing method patterns exactly):

1. `ListDomains(ctx context.Context) ([]Domain, error)` — GET /api/organization/{zoid}/domains. No pagination needed (all domains returned in one response). Decode DomainListResponse. Return Data slice.

2. `GetDomain(ctx context.Context, domainName string) (*Domain, error)` — GET /api/organization/{zoid}/domains/{domainName}. Decode DomainDetailResponse. Return &Data.

3. `AddDomain(ctx context.Context, domainName string) (*Domain, error)` — POST /api/organization/{zoid}/domains. Marshal AddDomainRequest. Expect HTTP 201 Created. Decode DomainDetailResponse. Return &Data. The response includes verification codes (TXT, CNAME, HTML) that the user needs for DNS setup.

4. `VerifyDomain(ctx context.Context, domainName, method string) error` — PUT /api/organization/{zoid}/domains/{domainName}. Validate method is one of: "verifyDomainByTXT", "verifyDomainByCName", "verifyDomainByHTML". Marshal DomainModeRequest. Expect HTTP 200.

5. `UpdateDomainSettings(ctx context.Context, domainName, mode string) error` — PUT /api/organization/{zoid}/domains/{domainName}. For modes like "enableHosting", "setPrimary", "enableDkim". Marshal DomainModeRequest. Expect HTTP 200. Validate mode against allowed values: "enableHosting", "disableHosting", "setPrimary", "enableDkim", "disableDkim".

Follow the EXACT error handling pattern from existing methods: check resp.StatusCode, call ac.parseErrorResponse(resp), decode JSON, check Status.Code != 200.
  </action>
  <verify>
Run `go build ./internal/zoho/...` and `go vet ./internal/zoho/...` — both must pass with no errors or warnings.
  </verify>
  <done>
Domain types defined in types.go. Five AdminClient methods (ListDomains, GetDomain, AddDomain, VerifyDomain, UpdateDomainSettings) compile and follow established patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Domain CLI commands and registration</name>
  <files>internal/cli/admin_domains.go, internal/cli/cli.go</files>
  <action>
**Create internal/cli/admin_domains.go** following the exact patterns from admin_groups.go:

1. **AdminDomainsListCmd** — No flags needed (all domains returned). Call ac.ListDomains(ctx). Print list with columns: Domain, Verified (bool as "Yes"/"No"), MX, DKIM (bool as "Yes"/"No"), SPF (bool as "Yes"/"No"), Primary (bool as "Yes"/"No"). Use fp.Formatter.PrintList() with output.Column definitions.

2. **AdminDomainsGetCmd** — `Name string` arg (required, positional). Call ac.GetDomain(ctx, cmd.Name). Print full domain details via fp.Formatter.Print(). Show all fields including verification codes (TXT record, CNAME code, HTML code) — these are critical for users setting up DNS.

3. **AdminDomainsAddCmd** — `Name string` arg (required, positional). Call ac.AddDomain(ctx, cmd.Name). Print the created domain details via fp.Formatter.Print(). After printing, also print verification instructions to stderr: "Domain added. To verify ownership, add the following DNS records:" followed by the TXT record value and CNAME value from the response.

4. **AdminDomainsVerifyCmd** — `Name string` arg (required), `Method string` flag (required, enum: "txt", "cname", "html"). Map user-friendly method names to API values: "txt" → "verifyDomainByTXT", "cname" → "verifyDomainByCName", "html" → "verifyDomainByHTML". Call ac.VerifyDomain(ctx, cmd.Name, apiMethod). Print success message to stderr: "Domain verification initiated for {name} using {method} method."

5. **AdminDomainsUpdateCmd** — `Name string` arg (required), `Setting string` flag (required, enum: "enable-hosting", "disable-hosting", "set-primary", "enable-dkim", "disable-dkim"). Map CLI setting names to API mode values: "enable-hosting" → "enableHosting", "disable-hosting" → "disableHosting", etc. Call ac.UpdateDomainSettings(ctx, cmd.Name, apiMode). Print success to stderr.

All commands use `newAdminClient(cfg)` helper (already defined in admin_users.go). All commands use the same error handling pattern: output.NewCLIError with appropriate exit codes (ExitAuth for auth errors, ExitAPIError for API errors, ExitGeneral for other).

**In internal/cli/cli.go**, add domain registration:

1. Add `Domains AdminDomainsCmd` field to `AdminCmd` struct (alongside Users and Groups).
2. Create `AdminDomainsCmd` struct with List, Get, Add, Verify, Update subcommands:
```go
type AdminDomainsCmd struct {
    List   AdminDomainsListCmd   `cmd:"" help:"List all domains"`
    Get    AdminDomainsGetCmd    `cmd:"" help:"Get domain details"`
    Add    AdminDomainsAddCmd    `cmd:"" help:"Add a new domain"`
    Verify AdminDomainsVerifyCmd `cmd:"" help:"Verify domain ownership"`
    Update AdminDomainsUpdateCmd `cmd:"" help:"Update domain settings"`
}
```
  </action>
  <verify>
Run `go build ./...` and `go vet ./...` — full project must compile. Then verify CLI structure: `./zoh admin domains --help` should show list, get, add, verify, update subcommands. `./zoh admin domains list --help`, `./zoh admin domains add --help`, `./zoh admin domains verify --help` should show correct flags.
  </verify>
  <done>
Five domain CLI commands (list, get, add, verify, update) registered under `zoh admin domains`. All output modes work. Verify command accepts method flag with txt/cname/html. Update command accepts setting flag with hosting/primary/dkim options.
  </done>
</task>

</tasks>

<verification>
1. `go build ./...` — Full project compiles with zero errors
2. `go vet ./...` — No warnings
3. `./zoh admin --help` — Shows "domains" alongside "users" and "groups"
4. `./zoh admin domains --help` — Shows all 5 subcommands
5. `./zoh admin domains verify --help` — Shows --method flag with txt/cname/html enum
6. `./zoh admin domains update --help` — Shows --setting flag with hosting/primary/dkim options
</verification>

<success_criteria>
- All five domain subcommands (list, get, add, verify, update) compile and are accessible via CLI
- Domain types and API client methods follow existing patterns (same error handling, response parsing, path construction)
- List command shows key domain attributes (name, verified, MX, DKIM, SPF, primary)
- Add command displays verification codes from API response
- Verify command maps user-friendly method names to API mode values
- Update command maps user-friendly setting names to API mode values
- All output modes (JSON, plain, rich) work for domain commands
</success_criteria>

<output>
After completion, create `.planning/phases/03-admin-domains-audit/03-01-SUMMARY.md`
</output>
